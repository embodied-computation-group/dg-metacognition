---
title: "R Notebook"
output: html_notebook
---
Anova: difference in d' and criterion between modalities.

```{r}

###Repated ANOVA for d': 
#Select relevant coulmns: 
dpC <- metadata_exc %>% select(modality, subject, starts_with("da")) %>%
  mutate("d-prime"=da, 
         modality=as.factor(modality)) %>% select(-da) %>% ungroup()

#dpC <- metadata_exc %>% select(modality, subject, starts_with("da")) %>%
#  mutate(modality=as.factor(modality)) %>% ungroup()

#Summary table: 
sum <- dpC %>% group_by(modality) %>% 
  get_summary_stats("d-prime", type="mean_sd")

#Get Anova: 
dpC_aov <- anova_test(data=dpC, dv="d-prime", wid=subject, within=modality)
get_anova_table(dpC_aov)

#Post-hoc: pairwise repeated t-tests
dpT <- dpC %>% pairwise_t_test(`d-prime` ~ modality, p.adjust.method = "bonferroni")

###Repated ANOVA for c: 
#Select relevant coulmns: 
CC <- metadata_exc %>% select(modality, subject, starts_with("c")) %>%
  mutate(Criterion=c, 
         modality=as.factor(modality)) %>% select(-c) %>% ungroup()

#Summary table: 
sum <- CC %>% group_by(modality) %>% 
  get_summary_stats(Criterion, type="mean_sd")

#Get Anova: 
CC_aov <- anova_test(data=CC, dv=Criterion, wid=subject, within=modality)
get_anova_table(CC_aov)

#Post-hoc: repeated t-tests
CT <- CC %>% pairwise_t_test(Criterion ~ modality, p.adjust.method = "bonferroni")


###APA format of Post hoc tests

#change layout and labels: 
dpT <- dpT %>% mutate(IV = .y.,
                      'Group 1' = group1,
                      'Group 1' = group2,
                      'p (Bonf)' = p.adj) %>% select(IV,'Group 1', 'Group 1', n1,n2, p, 'p (Bonf)')
CT <- CT  %>% mutate(IV = .y.,
                      'Group 1' = group1,
                      'Group 1' = group2,
                      'p (Bonf)' = p.adj) %>% select(IV,'Group 1', 'Group 1', n1,n2, p, 'p (Bonf)')

#NOTE I MANUALLY CHANGE THE P-values to <.001 here! Thus with different data this may not be appropriate. 
dpT <- dpT %>%mutate(p = as.character("<.001"),
                         'p (Bonf)'= as.character("<.001"))
CT <- CT %>%mutate(p = as.character("<.001"),
                         'p (Bonf)'= as.character("<.001"))

Dprimeapa<-apa(dpT, "Table 1: Post Hoc: Paired t-tests of cognitive sensitivity (d')")
Capa <-apa(CT, "Table 2: Post Hoc: Paired t-tests of cognitive decision criterion (c)")

Dprimeapa
Capa

```



Correlation  between domains: Using GRousselet bootcorci
```{r}

# Each correlation pair is estimated for Metacognitive sensitivity: 
corr <- fit_data_wide %>%
  na.omit() %>%
  select(starts_with("mda"))
res1 <- corci(corr$mda_memory, corr$mda_Calories, method="spearman")
res2 <- corci(corr$mda_memory, corr$mda_vision, method="spearman")
res3 <- corci(corr$mda_memory, corr$mda_GDP, method="spearman")
res4 <- corci(corr$mda_GDP, corr$mda_vision, method="spearman")
res5 <- corci(corr$mda_GDP, corr$mda_Calories, method="spearman")
res6 <- corci(corr$mda_Calories, corr$mda_vision, method="spearman")

# Each correlation pair is estimated for efficiency: 
corr1 <- fit_data_wide %>%
  na.omit() %>%
  select(starts_with("mratio"))
res1.1 <- corci(corr1$mratio_memory, corr1$mratio_Calories, method="spearman")
res1.2 <- corci(corr1$mratio_memory, corr1$mratio_vision, method="spearman")
res1.3 <- corci(corr1$mratio_memory, corr1$mratio_GDP, method="spearman")
res1.4 <- corci(corr1$mratio_GDP, corr1$mratio_vision, method="spearman")
res1.5 <- corci(corr1$mratio_GDP, corr1$mratio_Calories, method="spearman")
res1.6 <- corci(corr1$mratio_Calories, corr1$mratio_vision, method="spearman")

# Each correlation pair is estimated for bias: 
corr2 <- fit_data_wide %>%
  na.omit() %>%
  select(starts_with("avg"))
res2.1 <- corci(corr2$avg_conf_memory, corr2$avg_conf_Calories, method="spearman")
res2.2 <- corci(corr2$avg_conf_memory, corr2$avg_conf_vision, method="spearman")
res2.3 <- corci(corr2$avg_conf_memory, corr2$avg_conf_GDP, method="spearman")
res2.4 <- corci(corr2$avg_conf_GDP, corr2$avg_conf_vision, method="spearman")
res2.5 <- corci(corr2$avg_conf_GDP, corr2$avg_conf_Calories, method="spearman")
res2.6 <- corci(corr2$avg_conf_Calories, corr2$avg_conf_vision, method="spearman")

# Each correlation pair is estimated for Cognitive sensitivity: 
corr3 <- fit_data_wide %>%
  na.omit() %>%
  select(starts_with("da"))
res31 <- corci(corr3$da_memory, corr3$da_Calories, method="spearman")
res32 <- corci(corr3$da_memory, corr3$da_vision, method="spearman")
res33 <- corci(corr3$da_memory, corr3$da_GDP, method="spearman")
res34 <- corci(corr3$da_GDP, corr3$da_vision, method="spearman")
res35 <- corci(corr3$da_GDP, corr3$da_Calories, method="spearman")
res36 <- corci(corr3$da_Calories, corr3$da_vision, method="spearman")


#Table with correlation coefficents for all pairwise correlations: 
corrtable <- data.frame(Metric=character(),
                 MemCalCoef=double(),
                 CI_lowerMC=double(),
                 CI_upperMC=double(),
                 P_valueMC=double(),
                 MemVisCoef=double(),
                 CI_lowerMV=double(),
                 CI_upperMV=double(),
                 P_valueMV=double(),
                 MemGDPCoef=double(),
                 CI_lowerMG=double(),
                 CI_upperMG=double(),
                 P_valueMG=double(),
                 GDPVisCoef=double(),
                 CI_lowerGS=double(),
                 CI_upperGS=double(),
                 P_valueGS=double(),
                 GDPCalCoef=double(),
                 CI_lowerGC=double(),
                 CI_upperGC=double(),
                 P_valueGC=double(),
                 CalVisCoef=double(),
                 CI_lowerCV=double(),
                 CI_upperCV=double(),
                 P_valueCV=double(),
                stringsAsFactors=FALSE)

#Insert vaules in dataframe: 
corrtable[1,] <- list("Meta-d",res1$estimate,res1$conf.int[1], res1$conf.int[2], res1$p.value,
                       res2$estimate,res2$conf.int[1], res2$conf.int[2], res2$p.value,
                       res3$estimate,res3$conf.int[1], res3$conf.int[2],  res3$p.value,
                       res4$estimate,res4$conf.int[1], res4$conf.int[2],  res4$p.value,
                       res5$estimate,res5$conf.int[1], res5$conf.int[2],  res5$p.value,
                       res6$estimate,res6$conf.int[1],  res6$conf.int[2], res6$p.value)
corrtable[2,] <- list("Mratio",res1.1$estimate,res1.1$conf.int[1], res1.1$conf.int[2],
                      res1.1$p.value,res1.2$estimate,res1.2$conf.int[1], res1.2$conf.int[2],
                      res1.2$p.value, res1.3$estimate,res1.3$conf.int[1], res1.3$conf.int[2],
                      res1.3$p.value, res1.4$estimate,res1.4$conf.int[1], res1.4$conf.int[2],
                      res1.4$p.value, res1.5$estimate,res1.5$conf.int[1], res1.5$conf.int[2],
                      res1.5$p.value, res1.6$estimate,res1.6$conf.int[1],  res1.6$conf.int[2],
                      res1.6$p.value)

corrtable[3,] <- list("Bias",res1$estimate,res2.1$conf.int[1], res2.1$conf.int[2],
                      res2.1$p.value,res2.2$estimate,res2.2$conf.int[1], res2.2$conf.int[2],
                      res2.2$p.value,res2.3$estimate,res2.3$conf.int[1], res2.3$conf.int[2], 
                      res2.3$p.value,res2.4$estimate,res2.4$conf.int[1], res2.4$conf.int[2], 
                      res2.4$p.value,res2.5$estimate,res2.5$conf.int[1], res2.5$conf.int[2],
                      res2.5$p.value,res2.6$estimate,res2.6$conf.int[1], res2.6$conf.int[2],
                      res2.6$p.value)
corrtable[4,] <- list("d'",res31$estimate,res31$conf.int[1], res31$conf.int[2], res31$p.value,
                       res32$estimate,res32$conf.int[1], res32$conf.int[2], res32$p.value,
                       res33$estimate,res33$conf.int[1], res33$conf.int[2],  res33$p.value,
                       res34$estimate,res34$conf.int[1], res34$conf.int[2],  res34$p.value,
                       res35$estimate,res35$conf.int[1], res35$conf.int[2],  res35$p.value,
                       res36$estimate,res36$conf.int[1],  res36$conf.int[2], res36$p.value)

head(corrtable)


```



Plot the bootstrap samples of correlations: GRusselete 
```{r}

b1 <- plotBoot(res1) + ggtitle("Memory and Calories")
b2 <- plotBoot(res2) + ggtitle("Memory and Vision")
b3 <- plotBoot(res3) + ggtitle("Memory and GDP")
b4 <- plotBoot(res4) + ggtitle("GDP and Vision")
b5 <- plotBoot(res5) + ggtitle("GDP and Calories")
b6 <- plotBoot(res6) + ggtitle("Vision and Calories")
BootPlot1 <- ggarrange(b1, b2, b3, b4, b5, b6)
annotate_figure(BootPlot1, top = text_grob("Bootstrap samples of Meta-d' correlations", color = "black", 
                                         face = "bold", size = 14))  

b11 <- plotBoot(res1.1) + ggtitle("Memory and Calories")
b12 <- plotBoot(res1.2) + ggtitle("Memory and Vision")
b13 <- plotBoot(res1.3) + ggtitle("Memory and GDP")
b14 <- plotBoot(res1.4) + ggtitle("GDP and Vision")
b15 <- plotBoot(res1.5) + ggtitle("GDP and Calories")
b16 <- plotBoot(res1.6) + ggtitle("Vision and Calories")
BootPlot2 <- ggarrange(b11, b12, b13, b14, b15, b16)
annotate_figure(BootPlot2, top = text_grob("Bootstrap samples of Mratio correlations Efficiency", color = "black", 
                                         face = "bold", size = 14))  
b21 <- plotBoot(res2.1) + ggtitle("Memory and Calories")
b22 <- plotBoot(res2.2) + ggtitle("Memory and Vision")
b23 <- plotBoot(res2.3) + ggtitle("Memory and GDP")
b24 <- plotBoot(res2.4) + ggtitle("GDP and Vision")
b25 <- plotBoot(res2.5) + ggtitle("GDP and Calories")
b26 <- plotBoot(res2.6) + ggtitle("Vision and Calories")
BootPlot3 <- ggarrange(b21, b22, b23, b24, b25, b26)
annotate_figure(BootPlot3, top = text_grob("Bootstrap samples of Meta-bias correlations", color = "black", 
                                         face = "bold", size = 14))  

BootPlot3

ggsave(here("figs", "bootplot3.png"), height = 16.8/3, width = 16.8, dpi = 300)
```

Now we calculate and plot the Bayes factors for the correlations: 
!!! COMBINE PLOTS + SUMMARY OF Stats. 
```{r}
# Metacognitive sensitivity 
 source(here("r", "Bayesfactor.R"))
  
bf1 <- bayes(corr$mda_memory, corr$mda_Calories)
bf2 <- bayes(corr$mda_memory, corr$mda_vision)
bf3 <- bayes(corr$mda_memory, corr$mda_GDP)
bf4 <- bayes(corr$mda_GDP, corr$mda_vision)
bf5 <- bayes(corr$mda_GDP, corr$mda_Calories)
bf6 <- bayes(corr$mda_Calories, corr$mda_vision)
BayesPlot1 <- ggarrange(plot, bf2, bf3, bf4, bf5, bf6)
annotate_figure(BayesPlot1, top = text_grob("Bayesfactor samples of Meta-d' correlations", color = "black", 
                                         face = "bold", size = 14))  
#Metacognitive Efficiency
bf11 <- bayes(corr1$mratio_memory, corr1$mratio_Calories)
bf12 <- bayes(corr1$mratio_memory, corr1$mratio_vision)
bf13 <- bayes(corr1$mratio_memory, corr1$mratio_GDP)
bf14 <- bayes(corr1$mratio_GDP, corr1$mratio_vision)
bf15 <- bayes(corr1$mratio_GDP, corr1$mratio_Calories)
bf16 <- bayes(corr1$mratio_Calories, corr1$mratio_vision)
BayesPlot2 <- ggarrange(bf11, bf12, bf13, bf14, bf15, bf16)
annotate_figure(BayesPlot2, top = text_grob("Bayesfactor samples of Mratio' correlations", color = "black", 
                                         face = "bold", size = 14))  
#Metacognitive bias 
bf1 <- bayes(corr2$avg_conf_memory, corr2$avg_conf_Calories)
bf2 <- bayes(corr2$avg_conf_memory, corr2$avg_conf_vision)
bf3 <- bayes(corr2$avg_conf_memory, corr2$avg_conf_GDP)
bf4 <- bayes(corr2$avg_conf_GDP, corr2$avg_conf_vision)
bf5 <- bayes(corr2$avg_conf_GDP, corr2$avg_conf_Calories)
bf6 <- bayes(corr2$avg_conf_Calories, corr2$avg_conf_vision)
BayesPlot1 <- ggarrange(bf21, bf22, bf23, bf24, bf25, bf26)
annotate_figure(BayesPlot1, top = text_grob("Bayesfactor samples of Meta-d' correlations", color = "black", 
                                         face = "bold", size = 14))  


```


Figure 3:  
```{r}

#The scatter plot for the MLE estimation of Mratio: 
#Metacognitive Efficiency
#Indicate the estimated correlations: 

S1title <- paste("r =",round(res1.1$estimate, digits=3))
S2title <- paste("r =",round(res1.2$estimate, digits=3))
S3title <- paste("r =",round(res1.3$estimate, digits=3))
S4title <- paste("r =",round(res1.4$estimate, digits=3))
S5title <- paste("r =",round(res1.5$estimate, digits=3))
S6title <- paste("r =",round(res1.6$estimate, digits=3))


scat2 <- as_tibble(corr1)
s11 <- scatter(scat2, scat2$mratio_memory, scat2$mratio_Calories) + theme(plot.title = element_text( size = 10)) + scale_y_continuous("Calories")+scale_x_continuous("Memory") + ggtitle(paste(S1title))
s12 <- scatter(scat2, scat2$mratio_memory, scat2$mratio_vision) + theme(plot.title = element_text( size = 10)) + scale_y_continuous("Vision")+scale_x_continuous("Memory") + ggtitle(paste(S2title))
s13 <- scatter(scat2, scat2$mratio_memory, scat2$mratio_GDP) + theme(plot.title = element_text( size = 10)) + scale_y_continuous("GDP")+scale_x_continuous("Memory") + ggtitle(paste(S3title))
s14 <- scatter(scat2, scat2$mratio_GDP, scat2$mratio_vision) +  theme(plot.title = element_text( size = 10)) +scale_y_continuous("Vision")+scale_x_continuous("GDP") + ggtitle(paste(S4title))
s15 <- scatter(scat2, scat2$mratio_GDP, scat2$mratio_Calories) + theme(plot.title = element_text( size = 10)) + scale_y_continuous("Calories")+ scale_x_continuous("GDP") + ggtitle(paste(S5title))
s16 <- scatter(scat2, scat2$mratio_Calories, scat2$mratio_vision) + theme(plot.title = element_text( size = 10)) + scale_y_continuous("Vision")+scale_x_continuous("Calories") + ggtitle(paste(S6title))

comPlot2 <- ggarrange(s11, s12, s13, s14, s15, s16) 
annotate_figure(comPlot2, top = text_grob("Metacognitive Efficiency", color = "black", 
                                         face = "bold", size = 14))    

#The plots for the hierarhical model - sample estimations of rho: 

#For Astrid: 
output <- readRDS("C:/Users/Astrid/Documents/DomainGen/modelfit.RDS")

fit_filename = "/home/micah/metad_groupfit.RDS" ## change this to the correct place! 

if (file.exists(fit_filename) == 1 ) {

output <- readRDS(fit_filename)
  
} else{
  
message("OBS: You need to fit the hierarhical model using 'fit_hierarhicical_metamodel.rmd' - this will take a LONG time")

}

#Prepare the hierarhical fit for the figure: 
Value <- gelman.diag(output, confidence = 0.95)
Rhat <- data.frame(conv = Value$psrf)


# Values (mean and CI)
Value <- summary(output)
stat <- data.frame(mean = Value$statistics[,"Mean"])
stat %<>%
  rownames_to_column(var = "name") %>% 
  cbind(CILow = Value$quantiles[,"2.5%"]) %>% 
  cbind(CIUp = Value$quantiles[,"97.5%"])


# HDI function 
HDI <- data.frame(HPDinterval(output, prob = 0.95))
HDI %<>%
  rownames_to_column(var = "name")

# Posterior distributions 
mcmc.sample <- ggs(output) 


mcmc.rho <- mcmc.sample %>% 
  filter(Parameter == "rho[1]"| Parameter == "rho[2]"| Parameter == "rho[3]"| Parameter == "rho[4]"| Parameter == "rho[5]"| Parameter == "rho[6]")

#Plot titles: 
meanRho <- mcmc.rho %>% group_by(Parameter) %>% summarise(value= mean(value, na.rm=TRUE)) 

#Fit stats summary. 
Fit <- stat %>%
  cbind(lower = HDI$lower,
        upper = HDI$upper,
        Rhat = Rhat[,1])

H1title <- paste("Rho =",round(meanRho$value[1], digits=3))
H2title <- paste("Rho =",round(meanRho$value[2], digits=3))
H3title <- paste("Rho =",round(meanRho$value[3], digits=3))
H4title <- paste("Rho =",round(meanRho$value[4], digits=3))
H5title <- paste("Rho =",round(meanRho$value[5], digits=3))
H6title <- paste("Rho =",round(meanRho$value[6], digits=3))

# split per correlation pair: 
Rho1 <- mcmc.sample %>% filter(Parameter == "rho[1]") 
Rho2 <- mcmc.sample %>% filter(Parameter == "rho[2]") 
Rho3 <- mcmc.sample %>% filter(Parameter == "rho[3]") 
Rho4 <- mcmc.sample %>% filter(Parameter == "rho[4]") 
Rho5 <- mcmc.sample %>% filter(Parameter == "rho[5]") 
Rho6 <- mcmc.sample %>% filter(Parameter == "rho[6]") 

#plot Rho samples + indication of mean rho estimation 
R1 <- RhoPlot(Rho1, "rho[1]") + labs(title = "Memory and Calories", subtitle= paste(H1title))
R2 <- RhoPlot(Rho2, "rho[2]") + labs(title = "Memory and GDP", subtitle= paste(H2title))
R3 <- RhoPlot(Rho3, "rho[3]") + labs(title = "Memory and Vision", subtitle= paste(H3title))
R4 <- RhoPlot(Rho4, "rho[4]") + labs(title = "GDP and Calories", subtitle= paste(H4title))
R5 <- RhoPlot(Rho5, "rho[5]") + labs(title = "Calories and Vision", subtitle= paste(H5title))
R6 <- RhoPlot(Rho6, "rho[6]") + labs(title = "GDP and Vision", subtitle= paste(H6title))

#Combine plots for the hierarhical fit: 
RhoPlot <- ggarrange(R1, R3, R2, R6, R4, R5)
CorHi <- annotate_figure(RhoPlot, top = text_grob("Hierarhical Bayesian estimation", color = "black", face = "bold", size = 14)) 

#MLE fit:
CorMLE <- annotate_figure(comPlot2, top = text_grob("Maximum likelihood estimation  ", color = "black", face = "bold", size = 14)) 

#Combine MLe and hierarhical estimation of correlations: 
Figure3 <- ggarrange(CorMLE, CorHi, ncol= 1, nrow=2)  
  annotate_figure(Figure3, top = text_grob("Figure 3", color = "black",face = "bold", size = 14))

  
ggsave(here("figs", "Figure 3.png"), height = 7, width = 12)  

```




Figure 3 without Mratio outliers: 
```{r}

#exclude those where mratio could not be estimated (MLE):  
metadata_excMratio <- metadata_exc%>%filter(mratio!="NaN")

#mratio
metadata_excMratio <- metadata_excMratio%>%
  group_by(modality) %>%
  mutate(mratio = remove_outliers_robust(mratio)) 

#Pivot: 
fit_data_wideExc <- metadata_excMratio %>% pivot_wider(
  names_from = modality,
  values_from = c(da, mda, mratio, c, avg_conf)
)
  
#estimate correlation: 
corr1E <- fit_data_wideExc %>%
  na.omit() %>%
  select(starts_with("mratio"))
res1.1E <- corci(corr1E$mratio_memory, corr1E$mratio_Calories, method="spearman")
res1.2E <- corci(corr1E$mratio_memory, corr1E$mratio_vision, method="spearman")
res1.3E <- corci(corr1E$mratio_memory, corr1E$mratio_GDP, method="spearman")
res1.4E <- corci(corr1E$mratio_GDP, corr1E$mratio_vision, method="spearman")
res1.5E <- corci(corr1E$mratio_GDP, corr1E$mratio_Calories, method="spearman")
res1.6E <- corci(corr1E$mratio_Calories, corr1E$mratio_vision, method="spearman")

#put in dataframe: 
corrtableE <- data.frame(Metric=character(),
                 MemCalCoef=double(),
                 CI_lowerMC=double(),
                 CI_upperMC=double(),
                 P_valueMC=double(),
                 MemVisCoef=double(),
                 CI_lowerMV=double(),
                 CI_upperMV=double(),
                 P_valueMV=double(),
                 MemGDPCoef=double(),
                 CI_lowerMG=double(),
                 CI_upperMG=double(),
                 P_valueMG=double(),
                 GDPVisCoef=double(),
                 CI_lowerGS=double(),
                 CI_upperGS=double(),
                 P_valueGS=double(),
                 GDPCalCoef=double(),
                 CI_lowerGC=double(),
                 CI_upperGC=double(),
                 P_valueGC=double(),
                 CalVisCoef=double(),
                 CI_lowerCV=double(),
                 CI_upperCV=double(),
                 P_valueCV=double(),
                stringsAsFactors=FALSE)

corrtableE[1,] <- list("Mratio",res1.1E$estimate, res1.1E$conf.int[1], res1.1E$conf.int[2],
                      res1.1E$p.value, res1.2E$estimate,res1.2E$conf.int[1],
                      res1.2E$conf.int[2], res1.2E$p.value, res1.3E$estimate,
                      res1.3E$conf.int[1], res1.3E$conf.int[2], res1.3E$p.value,
                      res1.4E$estimate,res1.4E$conf.int[1], res1.4E$conf.int[2],
                      res1.4E$p.value, res1.5E$estimate,res1.5E$conf.int[1], 
                      res1.5E$conf.int[2], res1.5E$p.value, res1.6E$estimate,
                      res1.6E$conf.int[1],  res1.6E$conf.int[2], res1.6E$p.value)

S1Etitle <- paste("r =",round(res1.1E$estimate, digits=3))
S2Etitle <- paste("r =",round(res1.2E$estimate, digits=3))
S3Etitle <- paste("r =",round(res1.3E$estimate, digits=3))
S4Etitle <- paste("r =",round(res1.4E$estimate, digits=3))
S5Etitle <- paste("r =",round(res1.5E$estimate, digits=3))
S6Etitle <- paste("r =",round(res1.6E$estimate, digits=3))

#Plot the correlations: 
scat2E <- as_tibble(corr1E)
s11E <-scatter(scat2E, scat2E$mratio_memory, scat2E$mratio_Calories) + theme(plot.title = element_text( size = 10)) +
  scale_y_continuous("Calories")+scale_x_continuous("Memory") + ggtitle(paste(S1Etitle))
s12E <- scatter(scat2E, scat2E$mratio_memory, scat2E$mratio_vision) + theme(plot.title = element_text( size = 10)) +
  scale_y_continuous("Vision")+scale_x_continuous("Memory") + ggtitle(paste(S2Etitle))
s13E <- scatter(scat2E, scat2E$mratio_memory, scat2E$mratio_GDP) + theme(plot.title = element_text( size = 10)) +
  scale_y_continuous("GDP")+scale_x_continuous("Memory") + ggtitle(paste(S3Etitle))
s14E <- scatter(scat2E, scat2E$mratio_GDP, scat2E$mratio_vision) + theme(plot.title = element_text( size = 10)) +
  scale_y_continuous("Vision")+scale_x_continuous("GDP") + ggtitle(paste(S4Etitle))
s15E <- scatter(scat2E, scat2E$mratio_GDP, scat2E$mratio_Calories) + theme(plot.title = element_text( size = 10)) +
  scale_y_continuous("Calories")+ scale_x_continuous("GDP") + ggtitle(paste(S5Etitle))
s16E <- scatter(scat2E, scat2E$mratio_Calories, scat2E$mratio_vision) + theme(plot.title = element_text( size = 10)) +
  scale_y_continuous("Vision")+scale_x_continuous("Calories") + ggtitle(paste(S6Etitle))

comPlotE <- ggarrange(s11E, s12E, s13E, s14E, s15E, s16E) 
CorExcMLE<-annotate_figure(comPlotE, top = text_grob("Maximum likelihood estimation", color = "black", face = "bold", size = 14))   

#figure 3 now without MLE mratio outliers: 
Figure3E <- ggarrange(CorExcMLE, CorHi, ncol= 1, nrow=2)  
  annotate_figure(Figure3E, top = text_grob("Figure 3", color = "black",face = "bold", size = 14))

ggsave(here("figs", "Figure 3 without Outliers.png"), height = 7, width = 12)

```



Now the tables from the paper: 

Table 1: Demographics 
```{r}
#load the demographics information: 
survey_data_pre <- read_delim(here("data_summary", "/self_belief_pre_labels.csv"), 
                              ";", escape_double = FALSE, trim_ws = TRUE)

#Clean Data: 
survey_data_pre <- survey_data_pre %>% select(Sid, age, gender)

#Vector with IDs that should be included
ID_incl <- unique(metadata_exc$subject)

#demo only with included participants:
demo <- subset(survey_data_pre, is.element(survey_data_pre$Sid, ID_incl))

#summarise and format Gender:
demoG <- demo %>% group_by(gender) %>%
  summarise(mean1=length(gender)) %>% mutate(per = 100*mean1/321) %>%
  mutate(mean=paste0(round(mean1), paste0(" (", round(per,2), " %)"))) %>%
  select(gender, mean) %>% 
  pivot_wider(names_from = gender, values_from = mean)

#summarise and format age:
demoA <- demo %>% summarise(age1 =mean(age, na_rm=TRUE),
                         age_sd=sd(age, na.rm=TRUE)) %>% 
  mutate(age= paste0(round(age1), paste0(" (", round(age_sd,3), " SD)")))

  
#Combine in table
table1 <- data.frame(Descriptive=character(),
                     Count=double())

table1[1,] <- list("Feminine", demoG$Feminin)
table1[2,] <- list("Masculine", demoG$Masculin)
table1[3,] <- list("Non-binary", demoG$`non-binary`)
table1[4,] <- list("Age", demoA$age)

table1apa<-apa(table1, "Table 1: Demographics")
table1apa

```
Table 2: MLE correlation between domains 
```{r}

#combine upper and lower limit of CI into one. 
table2 <- corrtable %>% mutate(MC_CI = paste(round(corrtable$CI_lowerMC,3), round(corrtable$CI_upperMC,3), sep=";")) %>%
  mutate(MV_CI= paste(round(corrtable$CI_lowerMV,3), round(corrtable$CI_upperMV,3), sep=";")) %>%
  mutate(MG_CI= paste(round(corrtable$CI_lowerMG,3), round(corrtable$CI_upperMG,3), sep=";")) %>%
  mutate(GS_CI= paste(round(corrtable$CI_lowerGS,3), round(corrtable$CI_upperGS,3), sep=";")) %>%
  mutate(GC_CI= paste(round(corrtable$CI_lowerGC,3), round(corrtable$CI_upperGC,3), sep=";")) %>%
  mutate(CV_CI= paste(round(corrtable$CI_lowerCV,3), round(corrtable$CI_upperCV,3), sep=";")) 

#Select relevant columns 
table2 <- table2 %>% select(Metric, 
                            MemCalCoef, P_valueMC, MC_CI, 
                            MemVisCoef, P_valueMV, MV_CI, 
                            MemGDPCoef, P_valueMG, MG_CI, 
                            GDPVisCoef, P_valueGS, GS_CI,
                            GDPCalCoef, P_valueGC, GC_CI, 
                            CalVisCoef, P_valueCV, CV_CI
                            )

#Change the layout of the table: 

##Sensitivity 
#Table with correlation coefficents for all pairwise correlations: 
table22 <- data.frame(Pair=character(),
                 r=double(),
                 p=double(),
                 'Conf Interval'=double(),
                stringsAsFactors=FALSE)

#Insert vaules in dataframe: 
table22[1,] <- list("Memory & Calories",table2$MemCalCoef[1],table2$P_valueMC[1], table2$MC_CI[1])
table22[2,] <- list("Memory & Vision",table2$MemVisCoef[1],table2$P_valueMV[1], table2$MV_CI[1])
table22[3,] <- list("Memory & GDP",table2$MemGDPCoef[1],table2$P_valueMG[1], table2$MG_CI[1])
table22[4,] <- list("GDP & Vision",table2$GDPVisCoef[1],table2$P_valueGS[1], table2$GS_CI[1])
table22[5,] <- list("GDP & Calories",table2$GDPCalCoef[1],table2$P_valueGC[1], table2$GC_CI[1])
table22[6,] <- list("Calories & Vision",table2$CalVisCoef[1],table2$P_valueCV[1], table2$CV_CI[1])

##Sensitivity
#Table with correlation coefficents for all pairwise correlations: 
table23 <- data.frame(Pair=character(),
                 r=double(),
                 p=double(),
                 'Conf Interval'=double(),
                stringsAsFactors=FALSE)

#Insert vaules in dataframe: 
table23[1,] <- list("Memory & Calories",table2$MemCalCoef[2],table2$P_valueMC[2], table2$MC_CI[2])
table23[2,] <- list("Memory & Vision",table2$MemVisCoef[2],table2$P_valueMV[2], table2$MV_CI[2])
table23[3,] <- list("Memory & GDP",table2$MemGDPCoef[2],table2$P_valueMG[2], table2$MG_CI[2])
table23[4,] <- list("GDP & Vision",table2$GDPVisCoef[2],table2$P_valueGS[2], table2$GS_CI[2])
table23[5,] <- list("GDP & Calories",table2$GDPCalCoef[2],table2$P_valueGC[2], table2$GC_CI[2])
table23[6,] <- list("Calories & Vision",table2$CalVisCoef[2],table2$P_valueCV[2], table2$CV_CI[2])

##Bias
#Table with correlation coefficents for all pairwise correlations: 
table24 <- data.frame(Pair=character(),
                 r=double(),
                 p=double(),
                 'Conf Interval'=double(),
                stringsAsFactors=FALSE)

#Insert vaules in dataframe: 
table24[1,] <- list("Memory & Calories",table2$MemCalCoef[3],table2$P_valueMC[3], table2$MC_CI[3])
table24[2,] <- list("Memory & Vision",table2$MemVisCoef[3],table2$P_valueMV[3], table2$MV_CI[3])
table24[3,] <- list("Memory & GDP",table2$MemGDPCoef[3],table2$P_valueMG[3], table2$MG_CI[3])
table24[4,] <- list("GDP & Vision",table2$GDPVisCoef[3],table2$P_valueGS[3], table2$GS_CI[3])
table24[5,] <- list("GDP & Calories",table2$GDPCalCoef[3],table2$P_valueGC[3], table2$GC_CI[3])
table24[6,] <- list("Calories & Vision",table2$CalVisCoef[3],table2$P_valueCV[3], table2$CV_CI[3])

#NOTE I MANUALLY CHANGE THE P-values to <.001 here! Thus with different data this may not be appropriate. 
table24 <- table24 %>% mutate(p = as.character("<.001"))

#d' correlation: 
table25 <- data.frame(Pair=character(),
                 r=double(),
                 p=double(),
                 'Conf Interval'=double(),
                stringsAsFactors=FALSE)

#Insert vaules in dataframe: 
table25[1,] <- list("Memory & Calories",table2$MemCalCoef[4],table2$P_valueMC[4], table2$MC_CI[4])
table25[2,] <- list("Memory & Vision",table2$MemVisCoef[4],table2$P_valueMV[4], table2$MV_CI[4])
table25[3,] <- list("Memory & GDP",table2$MemGDPCoef[4],table2$P_valueMG[4], table2$MG_CI[4])
table25[4,] <- list("GDP & Vision",table2$GDPVisCoef[4],table2$P_valueGS[4], table2$GS_CI[4])
table25[5,] <- list("GDP & Calories",table2$GDPCalCoef[4],table2$P_valueGC[4], table2$GC_CI[4])
table25[6,] <- list("Calories & Vision",table2$CalVisCoef[4],table2$P_valueCV[4], table2$CV_CI[4])

#Sort decimals: 
table22 <- table22 %>% mutate(r = round(r,3))
table23 <- table23 %>% mutate(r = round(r,3))
table24 <- table24 %>% mutate(r = round(r,3))
table25 <- table25 %>% mutate(r = round(r,3))


#Makes tables in APA format: 
CorEff<-apa(table23, "Table 2.a: MLE correlation of Metacognitive Efficiency")
CorSen<-apa(table22, "Table 2.b: MLE correlation of Metacognitive Sensitivity")
CorBias<-apa(table24, "Table 2.c: MLE correlation of Metacognitive Bias")
CorD <-apa(table25, "Table 2.d: MLE correlation of Cognitive Sensitivity")

######Save tables. 
#######################
###

CorBias
CorSen
CorEff
CorD

```

Table 2: Hierarchical correlation of Metacognitive efficiency
NOTE you need the hierarhical fit to do this. 
```{r}

# select the HDIs for each rho  
rHDI <- HDI %>% filter(str_detect(name,"rho")) %>% select(name, lower, upper)
#join these HDIs with mean rho
RhoHDI <- full_join(meanRho, rHDI, 
                    by= c("Parameter"="name"))

#Change names and layout: 
Table2H <- RhoHDI %>% mutate(Pair= c("Memory & Calories", "Memory & Vision", "Memory & GDP", 
                                     "GDP & Vision", "GDP & Calories", "Calories & Vision"),
                             Rho=round(value,3),
                             HDI = paste(round(lower,3), round(upper,3), sep=";")
                             )
Table2H <- Table2H %>% select(Pair, Rho, HDI)

#Put into APA format. 

Table2Hapa<-apa(Table2H, "Table 3: Hierarhical Bayesian estimation of correlation of Metacognitive Efficiency")

######Save tables. 
#######################
###

Table2Hapa
  
```
Table 3: Average cognitive and Metacognitive performance across tasks 
```{r}

#Average everything and calculate standard deviations: 
metadata_avg <- metadata_exc %>% 
  group_by(modality) %>% 
  summarise(dprime=mean(da, na_rm=TRUE), 
            criterion=mean(c, na_rm=TRUE),
            metad=mean(mda, na_rm=TRUE),
            mratio1=mean(mratio, na_rm=TRUE),
            avg_conf1=mean(avg_conf, na_rm=TRUE),
            dprime_sd=sd(da),
            criterion_sd=sd(c),
            metad_sd=sd(mda),
            mratio_sd=sd(mratio),
            avg_conf_sd=sd(avg_conf)
            )
    
#Change format: 
tableMLE <- metadata_avg %>% mutate(Modality=c("Calories", "GDP", "Memory", "Vision"),
                                  'd-prime (SD)'=paste0((round(dprime,3)), paste0(" (", round(dprime_sd,3), ")")),
                                  'Criterion (SD)'=paste0((round(criterion,3)), paste0(" (", round(criterion_sd,3), ")")),
                                  'Meta-d (SD)'=paste0((round(metad,3)), paste0(" (", round(metad_sd,3), ")")),
                                  'Mratio (SD)'=paste0((round(mratio1,3)), paste0(" (", round(mratio_sd,3), ")")),
                                  'Avg Conf (SD)'=paste0((round(avg_conf1,3)), paste0(" (", round(avg_conf_sd,3), ")"))
                                  ) 
tableMLE <- tableMLE %>% select(Modality, 'd-prime (SD)', 'Criterion (SD)', 'Avg Conf (SD)', 'Meta-d (SD)'=, 'Mratio (SD)')   

# Mratio estimations from Hierarhical Model.  

#Select Mratio and take the expontial of the value:
meanMratio <- Fit %>% filter(str_detect(name,"mu_logMratio")) %>%
  mutate(mean=exp(mean), 
         lower=exp(lower),
         upper=exp(upper))
  
#format and select: 
meanMratio <- meanMratio %>% mutate(Modality=c("Calories", "GDP", "Memory", "Vision"),
         'HMratio (HDI)'=paste0(round(mean,3), paste0(" (", round(lower,3),";",round(upper,3), ")"))) 
         
meanMratio <- meanMratio %>% select(Modality, 'HMratio (HDI)')
  
#Join the two tables MLE and Hierarhical dataframes. 

table3 <- left_join(tableMLE, meanMratio, 
                     by=c("Modality"="Modality"))


#Put into APA format.                                     
table3apa<-apa(table3, "Table 4: Cognitive and Metacognitive performance")

######Save tables. 
#######################
###

table3apa

```

Here are some additional plots - you can un-comment these sections to see them.
Note that the individual staircase plots may take a LONG time to produce. 

Plots of key metacognitive measures for both filtered and unfiltered data: 
```{r}
#Source here to get the additional plots of the distribution of d', criterion,
#meta-d', bias and m-ratio across condition, both before and after group-level
#exclusion: 

#source(here("r", "MLE_plots.R"))

#Plots showing the comparison of filtered and unfiltered plots: 
#annotate_figure(filunfil1, top = text_grob("Cognitive Criterion filtered/unfiltered", color = "black", face = "bold", size = 14))
#annotate_figure(filunfil5, top = text_grob("Cognitive Sensitivity filtered/unfiltered", color = "black",face = "bold", size = 14))
#annotate_figure(filunfil2, top = text_grob("Metaognitive Bias filtered/unfiltered", color = "black", face = "bold", size = 14))
#annotate_figure(filunfil3, top = text_grob("Metacognitive Sensitivity filtered/unfiltered",   color = "black", face = "bold", size = 14))
#annotate_figure(filunfil4, top = text_grob("Metacognitive Efficiency filtered/unfiltered", color = "black",  face = "bold", size = 14))

#Plot the unfiltered data´: 
#annotate_figure(Dataunfil1, top = text_grob("MLE Estimation of Cognitive performance (unfiltered)", color = "black",face = "bold", size = 14))  
#annotate_figure(Dataunfil2, top = text_grob("MLE Estimation of Metacognitive performance (unfiltered)", color = "black", face = "bold", size = 14))  

#Plot the filtered data´: 
#annotate_figure(Datafil1, top = text_grob("MLE Estimation of Cognitive performance (filtered)", color = "black",face = "bold", size = 14))  
#annotate_figure(Datafi2, top = text_grob("MLE Estimation of Metacognitive performance (unfiltered)", color = "black", face = "bold", size = 14)) 

```

Additional scatter plots and linear regressions: 
```{r}
#For scatters plots of MLE estimation of metacognitive bias and sensitvity, 
#source here: 

#source(here("r", "Scatterplots.R"))

#Plot them: 
#annotate_figure(comPlot1, top = text_grob("Metacognitive Sensitivity", color = "black", face = "bold", size = 14))  
#annotate_figure(comPlot3, top = text_grob("Metacognitive Bias", color = "black", face = "bold", size = 14))   

```


Individual-level staircase plots: (Takes a long time)
```{r}
# note that this procedure can take a LONG time 
#uncomment to make individual plots for staircase procedure:

#source(here("r", "make_indivi_plots.R"))

```
