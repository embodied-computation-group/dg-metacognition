---
title: "ANOVA"
output: html_document
---
Setup - install packages and source functions. 
```{r}
# clean slate to be sure
rm(list = ls())

# check for pacman package and install if not found
if (!require("pacman")) install.packages("pacman")
pacman::p_load(afex, readr, dplyr, tidyr, ggplot2, cowplot, devtools, here, tidyverse, magrittr, reshape2, rjags, coda, lattice, ggmcmc, foreach, doParallel, ggpubr, ggpol, patchwork, ggcorrplot, ggstatsplot, GGally, BayesFactor, gridExtra, viridis, gghalves, gt, rstatix, scales)

# load the metaSDT package from github
if (!require("metaSDT")) devtools::install_github("craddm/metaSDT")
# load Rousselet correlation package 
if (!require("bootcorci")) devtools::install_github("GRousselet/bootcorci")

source(here("r", "remove_outliers_robust.R"))
source(here("r", "outliers.R"))
source(here("r", "trials2counts.R"))
source(here("r", "metad_indiv.R"))
source(here("r", "fit_mle.R"))
source(here("r", "sdt_functions.R"))
source(here("r", "Function_metad_groupcorr.R"))
source(here("r", "BootCorci.R"))
source(here("r", "Function_scatterplot.R"))
source(here("r", "function_rhoPlot.R"))
source(here("r", "function_apa.R"))

# set apa theme for plots
apatheme=theme_bw()+ #theme
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.border=element_blank(),
        axis.line=element_line(),
        text = element_text(size = 15),
        axis.title = element_text(size = 12))



# spider-man color palette

colors = c("#DF1F2D", "#B11313", "#2B3784", "#447BBE")

```

Load the data. 
```{r}
# read in the data

metacognition_trial_data <- read_csv(here("data_summary", "metacognition_TrialData_master.csv"), 
    col_types = cols(confidence = col_double(), 
        rt_conf = col_double()))

# set modality as factor
metacognition_trial_data$modality <- as.factor(metacognition_trial_data$modality )

# remove any rows containing NaNs (i.e., missing data)
metacognition_trial_data <- na.omit(metacognition_trial_data)

head(metacognition_trial_data)

```

Trial-level exclusion (following prereg)
```{r}

metadata <- metacognition_trial_data %>%
  group_by(subject, modality) %>%
  mutate(rt = remove_outliers_robust(rt)) # remove RT outliers using MAD Rule - SEE PRE REG

metadata <- na.omit(metadata)

#Exclude those with rt <50ms 
metadata <- metadata%>%filter(rt>=0.05) 

#Exclude those with less than 50% trials (i.e. less than 100 or 50) within condition
metadata<-metadata%>%mutate(modality=as.factor(modality))
metadatac<-metadata #create new dataframe
metadatac$modality <-fct_collapse (metadatac$modality, trivia = c("Calories", "GDP"))#combine the two trivia tasks in new dataframe
metadatac <- metadatac %>%
  group_by(subject, modality)%>% count(subject) #count number of trials
excD <- subset(metadatac, metadatac$n<100) 
excID <-unique(excD$subject) #Identify participants for exclusion
metadata <- subset(metadata, !is.element(metadata$subject, excID)) ##Exclude IDs from that vector in original dataframe

```

Load the fitted data: 
```{r}

fit_data <- read_csv("data_summary/mle_mratio_fit_data.csv")
```


Group-level exclusion based on MAD rule (confidence, d', criterion)
```{r}

#exclude those where mratio could not be estimated  
metadata_exc <- fit_data%>%filter(mratio!="NaN")


#Exclude outliers based on MAD rule (confidence, d' and criterion)
#Confidence:
Avgmeta <- metadata %>% 
  group_by(subject, modality) %>% 
  summarise(avg_conf=mean(confidence, na_rm=TRUE)) #Mean confidence for each modality

#join Avgmeta with fit_data 
fitAvg_data<- fit_data %>% full_join(Avgmeta, 
                                   by= c('subject'='subject', 
                                         'modality' = 'modality'))

fitAvg_data <- fitAvg_data%>%filter(mratio!="NaN")

metadata_exc <- fitAvg_data%>%
  group_by(modality) %>%
  mutate(avg_conf = remove_outliers_robust(avg_conf)) # remove RT outliers using MAD Rule 

# d' 
metadata_exc <- metadata_exc%>%
  group_by(modality) %>%
  mutate(da = remove_outliers_robust(da)) # remove RT outliers using MAD Rule 


# criterion 
metadata_exc <- metadata_exc%>%
  group_by(modality) %>%
  mutate(c = remove_outliers_robust(c)) # remove RT outliers using MAD Rule 

metadata_exc <- na.omit(metadata_exc)



head(metadata_exc)


```

Pivot the data frame to wide. 
```{r}

fit_data_wide <- metadata_exc %>% pivot_wider(
  names_from = modality,
  values_from = c(da, mda, mratio, c, avg_conf)
)
  

write.csv(fit_data_wide, file = here("data_summary","mle_mratio_fit_data_wide.csv"))

head(fit_data_wide)
```

Anova: difference in d', criterion metacognitive bias, sensitivity and efficiency between modalities.
+ Post hoc t-tests. 
```{r}

###Repated ANOVA for d': 
#Select relevant coulmns: 
dpC <- metadata_exc %>% select(modality, subject, starts_with("da")) %>%
  mutate(`d-prime`=da, 
         modality=as.factor(modality)) %>% select(-da) %>% ungroup()

#Summary table: 
sum <- dpC %>% group_by(modality) %>% 
  get_summary_stats(`d-prime`, type="mean_sd")

#Get Anova: 
dpC_aov <- anova_test(data=dpC, dv=`d-prime`, wid=subject, within=modality)
get_anova_table(dpC_aov)

#Post-hoc: pairwise repeated t-tests
dpT <- dpC %>% pairwise_t_test(`d-prime` ~ modality, p.adjust.method = "bonferroni")

###Repated ANOVA for c: 
#Select relevant coulmns: 
CC <- metadata_exc %>% select(modality, subject, starts_with("c")) %>%
  mutate(Criterion=c, 
         modality=as.factor(modality)) %>% select(-c) %>% ungroup()

#Summary table: 
sum1 <- CC %>% group_by(modality) %>% 
  get_summary_stats(Criterion, type="mean_sd")

#Get Anova: 
CC_aov <- anova_test(data=CC, dv=Criterion, wid=subject, within=modality)
get_anova_table(CC_aov)

#Post-hoc: repeated t-tests
CT <- CC %>% pairwise_t_test(Criterion ~ modality, p.adjust.method = "bonferroni")

## Repeated measures ANOVA of metacognitive bias: 
#Select relevant coulmns: 
MB <- metadata_exc %>% select(modality, subject, starts_with("avg")) %>%
  mutate(Bias=avg_conf, 
         modality=as.factor(modality)) %>% select(-avg_conf) %>% ungroup()

#Summary table: 
sum2 <- MB %>% group_by(modality) %>% 
  get_summary_stats(Bias, type="mean_sd")

#Get Anova: 
MB_aov <- anova_test(data=MB, dv=Bias, wid=subject, within=modality)
get_anova_table(MB_aov)

#Post-hoc: repeated t-tests
MBT <- MB %>% pairwise_t_test(Bias ~ modality, p.adjust.method = "bonferroni")


## Repeated measures ANOVA of meta-d':
#Select relevant coulmns: 
MS <- metadata_exc %>% select(modality, subject, starts_with("mda")) %>%
  mutate(Sensitivity=mda, 
         modality=as.factor(modality)) %>% select(-mda) %>% ungroup()

#Summary table: 
sum3 <- MS %>% group_by(modality) %>% 
  get_summary_stats(Sensitivity, type="mean_sd")

#Get Anova: 
MS_aov <- anova_test(data=MS, dv=Sensitivity, wid=subject, within=modality)
get_anova_table(MS_aov)

#Post-hoc: repeated t-tests
MST <- MS %>% pairwise_t_test(Sensitivity ~ modality, p.adjust.method = "bonferroni")

## Repeated measures ANOVA of mratio: 
#Select relevant coulmns: 
ME <- metadata_exc %>% select(modality, subject, starts_with("mratio")) %>%
  mutate(Efficiency=mratio, 
         modality=as.factor(modality)) %>% select(-mratio) %>% ungroup()

#Summary table: 
sum4 <- ME %>% group_by(modality) %>% 
  get_summary_stats(Efficiency, type="mean_sd")

#Get Anova: 
ME_aov <- anova_test(data=ME, dv=Efficiency, wid=subject, within=modality)
get_anova_table(ME_aov)

#Post-hoc: repeated t-tests
MET <- ME %>% pairwise_t_test(Efficiency ~ modality, p.adjust.method = "bonferroni")

```

Calculate degrees of freedoms:
```{r}

dpT <- dpT %>% mutate(df= )


```


Tables for ANOVAS and Post-hoc tests: 
```{r}
## Table of all ANOVAS: 



##Tables of all Post-hoc t-tests: 
DTT <- data.frame(Pair=character(),
                 t=double(),
                 p=double(),
                stringsAsFactors=FALSE)
CTT <-data.frame(Pair=character(),
                 t=double(),
                 p=double(),
                stringsAsFactors=FALSE)
MBTT <-data.frame(Pair=character(),
                 t=double(),
                 p=double(),
                stringsAsFactors=FALSE)
MSTT <-data.frame(Pair=character(),
                 t=double(),
                 p=double(),
                stringsAsFactors=FALSE)
METT <-data.frame(Pair=character(),
                 t=double(),
                 p=double(),
                stringsAsFactors=FALSE)

#change layout and labels: 
## the reported p is bonferroni  
DTT[1,] <- list(paste0(dpT$group1, "&", dpT$group2), , )

dpT <- dpT %>% mutate(IV = .y.,
                      'Group 1' = group1,
                      'Group 2' = group2,
                      'p (Bonf)' = p.adj) %>% select(IV,'Group 1', 'Group 2', n1,n2, p, 'p (Bonf)')

CT <- CT  %>% mutate(IV = .y.,
                      'Group 1' = group1,
                      'Group 2' = group2,
                      'p (Bonf)' = p.adj) %>% select(IV,'Group 1', 'Group 2', n1,n2, p, 'p (Bonf)')

tableSHT[1,] <- list("Memory", tableSH$Memory, paste0(tableSH$P_valueM, "(", (tableSH$Mem_CI), ")"))


#NOTE I MANUALLY CHANGED THE P-values to <.001 here! Thus with different data this may not be appropriate. 
dpT <- dpT %>%mutate(p = as.character("<.001"),
                         'p (Bonf)'= as.character("<.001"))
CT <- CT %>%mutate(p = as.character("<.001"),
                         'p (Bonf)'= as.character("<.001"))

Dprimeapa<-apa(dpT, "Table 1: Post Hoc: Paired t-tests of cognitive sensitivity (d')")
Capa <-apa(CT, "Table 2: Post Hoc: Paired t-tests of cognitive decision criterion (c)")

Dprimeapa
Capa

```