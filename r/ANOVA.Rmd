---
title: "ANOVA"
output: html_document
---
Setup - install packages and source functions. 
```{r}
# clean slate to be sure
rm(list = ls())

# check for pacman package and install if not found
if (!require("pacman")) install.packages("pacman")
pacman::p_load(afex, readr, dplyr, tidyr, ggplot2, cowplot, devtools, here, tidyverse, magrittr, reshape2, rjags, coda, lattice, ggmcmc, foreach, doParallel, ggpubr, ggpol, patchwork, ggcorrplot, ggstatsplot, GGally, BayesFactor, gridExtra, viridis, gghalves, gt, rstatix, scales)

# load the metaSDT package from github
if (!require("metaSDT")) devtools::install_github("craddm/metaSDT")
# load Rousselet correlation package 
if (!require("bootcorci")) devtools::install_github("GRousselet/bootcorci")

source(here("r", "remove_outliers_robust.R"))
source(here("r", "outliers.R"))
source(here("r", "trials2counts.R"))
source(here("r", "metad_indiv.R"))
source(here("r", "fit_mle.R"))
source(here("r", "sdt_functions.R"))
source(here("r", "Function_metad_groupcorr.R"))
source(here("r", "BootCorci.R"))
source(here("r", "Function_scatterplot.R"))
source(here("r", "function_rhoPlot.R"))
source(here("r", "function_apa.R"))

# set apa theme for plots
apatheme=theme_bw()+ #theme
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.border=element_blank(),
        axis.line=element_line(),
        text = element_text(size = 15),
        axis.title = element_text(size = 12))



# spider-man color palette

colors = c("#DF1F2D", "#B11313", "#2B3784", "#447BBE")

```

Load the data. 
```{r}
# read in the data

metacognition_trial_data <- read_csv(here("data_summary", "metacognition_TrialData_master.csv"), 
    col_types = cols(confidence = col_double(), 
        rt_conf = col_double()))

# set modality as factor
metacognition_trial_data$modality <- as.factor(metacognition_trial_data$modality )

# remove any rows containing NaNs (i.e., missing data)
metacognition_trial_data <- na.omit(metacognition_trial_data)

head(metacognition_trial_data)

```

Trial-level exclusion (following prereg)
```{r}

metadata <- metacognition_trial_data %>%
  group_by(subject, modality) %>%
  mutate(rt = remove_outliers_robust(rt)) # remove RT outliers using MAD Rule - SEE PRE REG

metadata <- na.omit(metadata)

#Exclude those with rt <50ms 
metadata <- metadata%>%filter(rt>=0.05) 

#Exclude those with less than 50% trials (i.e. less than 100 or 50) within condition
metadata<-metadata%>%mutate(modality=as.factor(modality))
metadatac<-metadata #create new dataframe
metadatac$modality <-fct_collapse (metadatac$modality, trivia = c("Calories", "GDP"))#combine the two trivia tasks in new dataframe
metadatac <- metadatac %>%
  group_by(subject, modality)%>% count(subject) #count number of trials
excD <- subset(metadatac, metadatac$n<100) 
excID <-unique(excD$subject) #Identify participants for exclusion
metadata <- subset(metadata, !is.element(metadata$subject, excID)) ##Exclude IDs from that vector in original dataframe

```

Load the fitted data: 
```{r}

fit_data <- read_csv(here("data_summary/mle_mratio_fit_data.csv"))
```


Group-level exclusion based on MAD rule (confidence, d', criterion)
```{r}

#exclude those where mratio could not be estimated  
metadata_exc <- fit_data%>%filter(mratio!="NaN")


#Exclude outliers based on MAD rule (confidence, d' and criterion)
#Confidence:
Avgmeta <- metadata %>% 
  group_by(subject, modality) %>% 
  summarise(avg_conf=mean(confidence, na_rm=TRUE)) #Mean confidence for each modality

#join Avgmeta with fit_data 
fitAvg_data<- fit_data %>% full_join(Avgmeta, 
                                   by= c('subject'='subject', 
                                         'modality' = 'modality'))

fitAvg_data <- fitAvg_data%>%filter(mratio!="NaN")

metadata_exc <- fitAvg_data%>%
  group_by(modality) %>%
  mutate(avg_conf = remove_outliers_robust(avg_conf)) # remove RT outliers using MAD Rule 

# d' 
metadata_exc <- metadata_exc%>%
  group_by(modality) %>%
  mutate(da = remove_outliers_robust(da)) # remove RT outliers using MAD Rule 


# criterion 
metadata_exc <- metadata_exc%>%
  group_by(modality) %>%
  mutate(c = remove_outliers_robust(c)) # remove RT outliers using MAD Rule 

metadata_exc <- na.omit(metadata_exc)



head(metadata_exc)


```


Exclude participants who does not have all data points. 
```{r}
# identify whether participants have data points in all domains, by measuring length:
rownum <- metadata_exc %>% group_by (subject) %>% summarise(length(modality))

#Identify those with less than four 
rowExc <- subset(rownum, rownum$`length(modality)`<4)
rowexcID <-unique(rowExc$subject)
#Exclude IDs from that vector in original dataframe:
metadata_exc <- subset(metadata_exc, !is.element(metadata_exc$subject, rowexcID))


```


Pivot the data frame to wide. 
```{r}

fit_data_wide <- metadata_exc %>% pivot_wider(
  names_from = modality,
  values_from = c(da, mda, mratio, c, avg_conf)
)
  

write.csv(fit_data_wide, file = here("data_summary","mle_mratio_fit_data_wide.csv"))

head(fit_data_wide)
```



Anova: difference in d', criterion metacognitive bias, sensitivity and efficiency between modalities.
+ Post hoc t-tests. 
```{r}

#ANOVA data frames: 
dpC_aov1 <- data.frame()
CC_aov1 <- data.frame()
MB_aov1 <- data.frame()
MS_aov1<- data.frame()
ME_aov1<- data.frame()

###Repated ANOVA for d': 
#Select relevant coulmns: 
dpC <- metadata_exc %>% select(modality, subject, starts_with("da")) %>%
  mutate(`d-prime`=da, 
         modality=as.factor(modality)) %>% select(-da) %>% ungroup()

#Summary table: 
sum <- dpC %>% group_by(modality) %>% 
  get_summary_stats(`d-prime`, type="mean_sd")

#Get Anova: 
dpC_aov <- anova_test(data=dpC, dv=`d-prime`, wid=subject, within=modality)
dpC_aov1 <- get_anova_table(dpC_aov)

#Post-hoc: pairwise repeated t-tests
dpT <- dpC %>% pairwise_t_test(`d-prime` ~ modality, paired =TRUE, p.adjust.method = "bonferroni")

###Repated ANOVA for c: 
#Select relevant coulmns: 
CC <- metadata_exc %>% select(modality, subject, starts_with("c")) %>%
  mutate(Criterion=c, 
         modality=as.factor(modality)) %>% select(-c) %>% ungroup()

#Summary table: 
sum1 <- CC %>% group_by(modality) %>% 
  get_summary_stats(Criterion, type="mean_sd")

#Get Anova: 
CC_aov <- anova_test(data=CC, dv=Criterion, wid=subject, within=modality)
CC_aov1 <-get_anova_table(CC_aov)

#Post-hoc: repeated t-tests
CT <- CC %>% pairwise_t_test(Criterion ~ modality, paired =TRUE, p.adjust.method = "bonferroni")

## Repeated measures ANOVA of metacognitive bias: 
#Select relevant coulmns: 
MB <- metadata_exc %>% select(modality, subject, starts_with("avg")) %>%
  mutate(Bias=avg_conf, 
         modality=as.factor(modality)) %>% select(-avg_conf) %>% ungroup()

#Summary table: 
sum2 <- MB %>% group_by(modality) %>% 
  get_summary_stats(Bias, type="mean_sd")

#Get Anova: 
MB_aov <- anova_test(data=MB, dv=Bias, wid=subject, within=modality)
MB_aov1 <- get_anova_table(MB_aov)

#Post-hoc: repeated t-tests
MBT <- MB %>% pairwise_t_test(Bias ~ modality, paired =TRUE, p.adjust.method = "bonferroni")


## Repeated measures ANOVA of meta-d':
#Select relevant coulmns: 
MS <- metadata_exc %>% select(modality, subject, starts_with("mda")) %>%
  mutate(Sensitivity=mda, 
         modality=as.factor(modality)) %>% select(-mda) %>% ungroup()

#Summary table: 
sum3 <- MS %>% group_by(modality) %>% 
  get_summary_stats(Sensitivity, type="mean_sd")

#Get Anova: 
MS_aov <- anova_test(data=MS, dv=Sensitivity, wid=subject, within=modality)
MS_aov1 <-get_anova_table(MS_aov)

#Post-hoc: repeated t-tests
MST <- MS %>% pairwise_t_test(Sensitivity ~ modality, paired =TRUE, p.adjust.method = "bonferroni")

## Repeated measures ANOVA of mratio: 
#Select relevant coulmns: 
ME <- metadata_exc %>% select(modality, subject, starts_with("mratio")) %>%
  mutate(Efficiency=mratio, 
         modality=as.factor(modality)) %>% select(-mratio) %>% ungroup()

#Summary table: 
sum4 <- ME %>% group_by(modality) %>% 
  get_summary_stats(Efficiency, type="mean_sd")

#Get Anova: 
ME_aov <- anova_test(data=ME, dv=Efficiency, wid=subject, within=modality)
ME_aov1 <- get_anova_table(ME_aov)

#Post-hoc: repeated t-tests
MET <- ME %>% pairwise_t_test(Efficiency ~ modality, paired =TRUE,p.adjust.method = "bonferroni")


```

Table of ANOVAs: 
```{r}

dpC_aov1 <- 
CC_aov1 <- 
MB_aov1 <- 
MS_aov1<- 
ME_aov1<- 

ANOT <- data.frame(
  Measure = character(), 
  `F`= character(), 
  p = character()
)  
  
ANOT[1,] <- list(paste0("d'"), paste0('F(', dpC_aov1$DFn, ',',dpC_aov1$DFd, ') = ', round(dpC_aov1$F, 3)), 
             paste0('p = ', dpC_aov1$p))
ANOT[2,] <- list(paste0("c"), paste0('F(', CC_aov1$DFn, ',',CC_aov1$DFd, ') = ', round(CC_aov1$F, 3)), 
             paste0('p = ', CC_aov1$p))
ANOT[3,] <- list(paste0("Avg. Conf"), paste0('F(', MB_aov1$DFn, ',',MB_aov1$DFd, ') = ', round(MB_aov1$F, 3)), 
             paste0('p = ', MB_aov1$p))
ANOT[4,] <- list(paste0("Meta-d'"), paste0('F(', MS_aov1$DFn, ',',MS_aov1$DFd, ') = ', round(MS_aov1$F, 3)), 
             paste0('p = ', MS_aov1$p))
ANOT[5,] <- list(paste0("M-ratio"), paste0('F(', ME_aov1$DFn, ',',ME_aov1$DFd, ') = ', round(ME_aov1$F, 3)), 
             paste0('p = ', ME_aov1$p))

#NOTE I MANUALLY CHANGE THE P-values to <.001 here! Thus with different data this may not be appropriate. 
ANOT <- ANOT %>% mutate(p = as.character("<.001"))  

#Put into APA format: 
ANOTapa<-apa(ANOT, "Table ???: ANOVA of metacognitive measures across domains") 
ANOTapa
  
```




Calculate degrees of freedoms for t-test:
```{r}

dpT <- dpT %>% mutate(df= n1 +n2 -2)
CT <- CT %>% mutate(df= n1 +n2 -2)
MBT <- MBT %>% mutate(df= n1 +n2 -2)
MST <- MST%>% mutate(df= n1 +n2 -2)
MET <- MET %>% mutate(df= n1 +n2 -2)

```


Tables Post-hoc tests: 
```{r}
## Table of all ANOVAS: 

##Tables of all Post-hoc t-tests: 
DTT <- data.frame(Pair=character(),
                 t=double(),
                 p=double(),
                stringsAsFactors=FALSE)
CTT <-data.frame(Pair=character(),
                 t=double(),
                 p=double(),
                stringsAsFactors=FALSE)
MBTT <-data.frame(Pair=character(),
                 t=double(),
                 p=double(),
                stringsAsFactors=FALSE)
MSTT <-data.frame(Pair=character(),
                 t=double(),
                 p=double(),
                stringsAsFactors=FALSE)
METT <-data.frame(Pair=character(),
                 t=double(),
                 p=double(),
                stringsAsFactors=FALSE)

#change layout and labels: 
## the reported p is bonferroni  
DTT[1:6,] <- list(paste0(dpT$group1, " & ", dpT$group2), paste0('t', '(', dpT$df, ') = ', round(dpT$statistic, 3)),   paste0('p = ', round(dpT$p.adj,3)))
CTT[1:6,] <- list(paste0(CT$group1, " & ", CT$group2), paste0('t', '(', CT$df, ') = ', round(CT$statistic, 3)),   paste0('p = ', round(CT$p.adj,3)))
MBTT[1:6,] <- list(paste0(MBT$group1, " & ", MBT$group2), paste0('t', '(', MBT$df, ') = ', round(MBT$statistic, 3)),   paste0('p = ', round(MBT$p.adj,3)))
MSTT[1:6,] <- list(paste0(MST$group1, " & ", MST$group2), paste0('t', '(', MST$df, ') = ', round(MST$statistic, 3)),   paste0('p = ', round(MST$p.adj,3)))
METT[1:6,] <- list(paste0(MET$group1, " & ", MET$group2), paste0('t', '(', MET$df, ') = ', round(MET$statistic, 3)),   paste0('p = ', round(MET$p.adj,3)))

#Change the p-value to <.001 when appropriate: 
DTT <- DTT %>% mutate(p = ifelse(p == 'p = 0', "p <.001", paste0(p)))
CTT <- CTT %>% mutate(p = ifelse(p == 'p = 0', "p <.001", paste0(p)))
MBTT <- MBTT %>% mutate(p = ifelse(p == 'p = 0', "p <.001", paste0(p)))
MSTT <- MSTT %>% mutate(p = ifelse(p == 'p = 0', "p <.001", paste0(p)))
METT <- METT %>% mutate(p = ifelse(p == 'p = 0', "p <.001", paste0(p)))

#Put into APA format: 
Dprimeapa<-apa(DTT, "Table 1: Post Hoc: Paired t-tests of cognitive sensitivity (d')")
Capa <-apa(CTT, "Table 2: Post Hoc: Paired t-tests of cognitive decision criterion (c)")
MBapa <-apa(MBTT, "Table 3: Post Hoc: Paired t-tests of Metacognitive bias (Avg conf)")
MSapa <-apa(MBTT, "Table 3: Post Hoc: Paired t-tests of Metacognitive Sensitivity (Meta-d')")
MEapa <-apa(MBTT, "Table 3: Post Hoc: Paired t-tests of Metacognitive Efficiency (M-ratio)")


Dprimeapa
Capa
MBapa
MSapa
MEapa

```