
Setup - install packages and source functions. 
```{r}
# clean slate to be sure
#rm(list = ls())

# check for pacman package and install if not found
if (!require("pacman")) install.packages("pacman")
pacman::p_load(afex, readr, dplyr, tidyr, ggplot2, cowplot, devtools, here, tidyverse, magrittr, reshape2, rjags, coda, lattice, ggmcmc, foreach, doParallel, ggpubr, ggpol, patchwork, ggcorrplot, ggstatsplot, GGally, BayesFactor, gridExtra, viridis, gghalves, gt, rstatix, scales, qgraph)

# load the metaSDT package from github
if (!require("metaSDT")) devtools::install_github("craddm/metaSDT")
# load Rousselet correlation package 
if (!require("bootcorci")) devtools::install_github("GRousselet/bootcorci")

source(here("r", "remove_outliers_robust.R"))
source(here("r", "outliers.R"))
source(here("r", "trials2counts.R"))
source(here("r", "metad_indiv.R"))
source(here("r", "fit_mle.R"))
source(here("r", "sdt_functions.R"))
source(here("r", "Function_metad_groupcorr.R"))
source(here("r", "BootCorci.R"))
source(here("r", "Function_scatterplot.R"))
source(here("r", "function_rhoPlot.R"))
source(here("r", "function_apa.R"))
source(here("r", "Bayesfactor.R"))


# set apa theme for plots
apatheme=theme_bw()+ #theme
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.border=element_blank(),
        axis.line=element_line(),
        text = element_text(size = 15),
        axis.title = element_text(size = 12))

# spider-man color palette

colors = c("#DF1F2D", "#B11313", "#2B3784", "#447BBE")

```

Load the data. 
```{r}
# read in the data

metacognition_trial_data <- read_csv(here("data_summary", "metacognition_TrialData_master.csv"), 
    col_types = cols(confidence = col_double(), 
        rt_conf = col_double()))

# set modality as factor
metacognition_trial_data$modality <- as.factor(metacognition_trial_data$modality )

# remove any rows containing NaNs (i.e., missing data)
metacognition_trial_data <- na.omit(metacognition_trial_data)

head(metacognition_trial_data)

```

Trial-level exclusion (following prereg)
```{r}

metadata <- metacognition_trial_data %>%
  group_by(subject, modality) %>%
  mutate(rt = remove_outliers_robust(rt)) # remove RT outliers using MAD Rule - SEE PRE REG

metadata <- na.omit(metadata)

#Exclude those with rt <50ms 
metadata <- metadata%>%filter(rt>=0.05) 

#Exclude those with less than 50% trials (i.e. less than 100 or 50) within condition
metadata<-metadata%>%mutate(modality=as.factor(modality))
metadatac<-metadata #create new dataframe
metadatac$modality <-fct_collapse (metadatac$modality, trivia = c("Calories", "GDP"))#combine the two trivia tasks in new dataframe
metadatac <- metadatac %>%
  group_by(subject, modality)%>% count(subject) #count number of trials
excD <- subset(metadatac, metadatac$n<100) 
excID <-unique(excD$subject) #Identify participants for exclusion
metadata <- subset(metadata, !is.element(metadata$subject, excID)) ##Exclude IDs from that vector in original dataframe

```

Let's loop over subjects now and fit the MLE model. 
```{r}

subjects = unique(metadata$subject) # subjects vector, for looping
modalities = as.character(unique(metadata$modality)) # modalities vector, for looping


# setup cluster
n.cores <- parallel::detectCores() - 1 # 1 less than max cores to prevent crashing

# since R can only work with around 120 cores maximum, set an upper limit if needed
if (n.cores > 120) {
n.cores <- 120
}


#create the cluster
my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
)

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)


# fit all subjects in parallel
source(here("r", "parMLEfit.R"))

# stop the cluster
stopCluster(cl = my.cluster)

# write out the data file
write.csv(fit_data, file = here("data_summary","mle_mratio_fit_data.csv"))

head(fit_data)

```

Group-level exclusion based on MAD rule (confidence, d', criterion)
```{r}

#Join metadata (which includes accuracy etc) and fit_data

#exclude those where mratio could not be estimated  
metadata_exc <- fit_data%>%filter(mratio!="NaN")

#Exclude outliers based on MAD rule (confidence, d' and criterion)
#Confidence:
Avgmeta <- metadata %>% 
  group_by(subject, modality) %>% 
  summarise(avg_conf=mean(confidence, na_rm=TRUE)) #Mean confidence for each modality

#join Avgmeta with fit_data 
fitAvg_data<- fit_data %>% full_join(Avgmeta, 
                                   by= c('subject'='subject', 
                                         'modality' = 'modality'))

fitAvg_data <- fitAvg_data%>%filter(mratio!="NaN")

metadata_exc <- fitAvg_data%>%
  group_by(modality) %>%
  mutate(avg_conf = remove_outliers_robust(avg_conf)) # remove average confidence using MAD Rule 

# d' 
metadata_exc <- metadata_exc%>%
  group_by(modality) %>%
  mutate(da = remove_outliers_robust(da)) # remove dprime outliers using MAD Rule 


# criterion 
metadata_exc <- metadata_exc%>%
  group_by(modality) %>%
  mutate(c = remove_outliers_robust(c)) # remove criterion outliers using MAD Rule 

metadata_exc <- na.omit(metadata_exc)

# add mratio exclusion 

metadata_exc <- metadata_exc%>%
  group_by(modality) %>%
  mutate(c = remove_outliers_robust(mratio)) # remove criterion outliers using MAD Rule 

metadata_exc <- na.omit(metadata_exc)

head(metadata_exc)


```

Pivot the data frame to wide. 
```{r}

fit_data_wide <- metadata_exc %>% pivot_wider(
  names_from = modality,
  values_from = c(da, mda, mratio, c, avg_conf)
)
  

write.csv(fit_data_wide, file = here("data_summary","mle_mratio_fit_data_wide.csv"))

head(fit_data_wide)
```

Correlation  between domains: Using GRousselet bootcorci
```{r}

# Each correlation pair is estimated for Metacognitive sensitivity: 
corr <- fit_data_wide %>%
  na.omit() %>%
  select(starts_with("mda"))
res1 <- corci(corr$mda_memory, corr$mda_Calories, method="spearman", nboot = 10000)
res2 <- corci(corr$mda_memory, corr$mda_vision, method="spearman", nboot = 10000))
res3 <- corci(corr$mda_memory, corr$mda_GDP, method="spearman", nboot = 10000))
res4 <- corci(corr$mda_GDP, corr$mda_vision, method="spearman", nboot = 10000))
res5 <- corci(corr$mda_GDP, corr$mda_Calories, method="spearman", nboot = 10000))
res6 <- corci(corr$mda_Calories, corr$mda_vision, method="spearman", nboot = 10000))

# Each correlation pair is estimated for efficiency: 
corr1 <- fit_data_wide %>%
  na.omit() %>%
  select(starts_with("mratio"))
res1.1 <- corci(corr1$mratio_memory, corr1$mratio_Calories, method="spearman")
res1.2 <- corci(corr1$mratio_memory, corr1$mratio_vision, method="spearman")
res1.3 <- corci(corr1$mratio_memory, corr1$mratio_GDP, method="spearman")
res1.4 <- corci(corr1$mratio_GDP, corr1$mratio_vision, method="spearman")
res1.5 <- corci(corr1$mratio_GDP, corr1$mratio_Calories, method="spearman")
res1.6 <- corci(corr1$mratio_Calories, corr1$mratio_vision, method="spearman")

# Each correlation pair is estimated for bias: 
corr2 <- fit_data_wide %>%
  na.omit() %>%
  select(starts_with("avg"))
res2.1 <- corci(corr2$avg_conf_memory, corr2$avg_conf_Calories, method="spearman")
res2.2 <- corci(corr2$avg_conf_memory, corr2$avg_conf_vision, method="spearman")
res2.3 <- corci(corr2$avg_conf_memory, corr2$avg_conf_GDP, method="spearman")
res2.4 <- corci(corr2$avg_conf_GDP, corr2$avg_conf_vision, method="spearman")
res2.5 <- corci(corr2$avg_conf_GDP, corr2$avg_conf_Calories, method="spearman")
res2.6 <- corci(corr2$avg_conf_Calories, corr2$avg_conf_vision, method="spearman")

# Each correlation pair is estimated for Cognitive sensitivity: 
corr3 <- fit_data_wide %>%
  na.omit() %>%
  select(starts_with("da"))
res31 <- corci(corr3$da_memory, corr3$da_Calories, method="spearman")
res32 <- corci(corr3$da_memory, corr3$da_vision, method="spearman")
res33 <- corci(corr3$da_memory, corr3$da_GDP, method="spearman")
res34 <- corci(corr3$da_GDP, corr3$da_vision, method="spearman")
res35 <- corci(corr3$da_GDP, corr3$da_Calories, method="spearman")
res36 <- corci(corr3$da_Calories, corr3$da_vision, method="spearman")


#Table with correlation coefficents for all pairwise correlations: 
corrtable <- data.frame(Metric=character(),
                 MemCalCoef=double(),
                 CI_lowerMC=double(),
                 CI_upperMC=double(),
                 P_valueMC=double(),
                 MemVisCoef=double(),
                 CI_lowerMV=double(),
                 CI_upperMV=double(),
                 P_valueMV=double(),
                 MemGDPCoef=double(),
                 CI_lowerMG=double(),
                 CI_upperMG=double(),
                 P_valueMG=double(),
                 GDPVisCoef=double(),
                 CI_lowerGS=double(),
                 CI_upperGS=double(),
                 P_valueGS=double(),
                 GDPCalCoef=double(),
                 CI_lowerGC=double(),
                 CI_upperGC=double(),
                 P_valueGC=double(),
                 CalVisCoef=double(),
                 CI_lowerCV=double(),
                 CI_upperCV=double(),
                 P_valueCV=double(),
                stringsAsFactors=FALSE)

#Insert vaules in dataframe: 
corrtable[1,] <- list("Meta-d",res1$estimate,res1$conf.int[1], res1$conf.int[2], res1$p.value,
                       res2$estimate,res2$conf.int[1], res2$conf.int[2], res2$p.value,
                       res3$estimate,res3$conf.int[1], res3$conf.int[2],  res3$p.value,
                       res4$estimate,res4$conf.int[1], res4$conf.int[2],  res4$p.value,
                       res5$estimate,res5$conf.int[1], res5$conf.int[2],  res5$p.value,
                       res6$estimate,res6$conf.int[1],  res6$conf.int[2], res6$p.value)
corrtable[2,] <- list("Mratio",res1.1$estimate,res1.1$conf.int[1], res1.1$conf.int[2],
                      res1.1$p.value,res1.2$estimate,res1.2$conf.int[1], res1.2$conf.int[2],
                      res1.2$p.value, res1.3$estimate,res1.3$conf.int[1], res1.3$conf.int[2],
                      res1.3$p.value, res1.4$estimate,res1.4$conf.int[1], res1.4$conf.int[2],
                      res1.4$p.value, res1.5$estimate,res1.5$conf.int[1], res1.5$conf.int[2],
                      res1.5$p.value, res1.6$estimate,res1.6$conf.int[1],  res1.6$conf.int[2],
                      res1.6$p.value)

corrtable[3,] <- list("Bias",res1$estimate,res2.1$conf.int[1], res2.1$conf.int[2],
                      res2.1$p.value,res2.2$estimate,res2.2$conf.int[1], res2.2$conf.int[2],
                      res2.2$p.value,res2.3$estimate,res2.3$conf.int[1], res2.3$conf.int[2], 
                      res2.3$p.value,res2.4$estimate,res2.4$conf.int[1], res2.4$conf.int[2], 
                      res2.4$p.value,res2.5$estimate,res2.5$conf.int[1], res2.5$conf.int[2],
                      res2.5$p.value,res2.6$estimate,res2.6$conf.int[1], res2.6$conf.int[2],
                      res2.6$p.value)
corrtable[4,] <- list("d'",res31$estimate,res31$conf.int[1], res31$conf.int[2], res31$p.value,
                       res32$estimate,res32$conf.int[1], res32$conf.int[2], res32$p.value,
                       res33$estimate,res33$conf.int[1], res33$conf.int[2],  res33$p.value,
                       res34$estimate,res34$conf.int[1], res34$conf.int[2],  res34$p.value,
                       res35$estimate,res35$conf.int[1], res35$conf.int[2],  res35$p.value,
                       res36$estimate,res36$conf.int[1],  res36$conf.int[2], res36$p.value)

head(corrtable)


```

Plot the bootstrap samples of the correlations: GRusselete 
```{r}

b1 <- plotBoot(res1) + ggtitle("Memory and Calories")
b2 <- plotBoot(res2) + ggtitle("Memory and Vision")
b3 <- plotBoot(res3) + ggtitle("Memory and GDP")
b4 <- plotBoot(res4) + ggtitle("GDP and Vision")
b5 <- plotBoot(res5) + ggtitle("GDP and Calories")
b6 <- plotBoot(res6) + ggtitle("Vision and Calories")
BootPlot1 <- ggarrange(b1, b2, b3, b4, b5, b6)
annotate_figure(BootPlot1, top = text_grob("Bootstrap samples of Meta-d' correlations", color = "black", 
                                         face = "bold", size = 14))  
ggsave(here("figs", "bootplot1.png"), height = 8, width = 8, dpi = 300)
b11 <- plotBoot(res1.1) + ggtitle("Memory and Calories")
b12 <- plotBoot(res1.2) + ggtitle("Memory and Vision")
b13 <- plotBoot(res1.3) + ggtitle("Memory and GDP")
b14 <- plotBoot(res1.4) + ggtitle("GDP and Vision")
b15 <- plotBoot(res1.5) + ggtitle("GDP and Calories")
b16 <- plotBoot(res1.6) + ggtitle("Vision and Calories")
BootPlot2 <- ggarrange(b11, b12, b13, b14, b15, b16)
annotate_figure(BootPlot2, top = text_grob("Bootstrap samples of Mratio correlations Efficiency", color = "black", 
                                         face = "bold", size = 14))  
ggsave(here("figs", "bootplot2.png"), height = 8, width = 8, dpi = 300)

b21 <- plotBoot(res2.1) + ggtitle("Memory and Calories")
b22 <- plotBoot(res2.2) + ggtitle("Memory and Vision")
b23 <- plotBoot(res2.3) + ggtitle("Memory and GDP")
b24 <- plotBoot(res2.4) + ggtitle("GDP and Vision")
b25 <- plotBoot(res2.5) + ggtitle("GDP and Calories")
b26 <- plotBoot(res2.6) + ggtitle("Vision and Calories")
BootPlot3 <- ggarrange(b21, b22, b23, b24, b25, b26)
annotate_figure(BootPlot3, top = text_grob("Bootstrap samples of Meta-bias correlations", color = "black", 
                                         face = "bold", size = 14))  

ggsave(here("figs", "bootplot3.png"), height = 8, width = 8, dpi = 300)


b31 <- plotBoot(res31) + ggtitle("Memory and Calories")
b32 <- plotBoot(res32) + ggtitle("Memory and Vision")
b33 <- plotBoot(res33) + ggtitle("Memory and GDP")
b34 <- plotBoot(res34) + ggtitle("GDP and Vision")
b35 <- plotBoot(res35) + ggtitle("GDP and Calories")
b36 <- plotBoot(res36) + ggtitle("Vision and Calories")
BootPlot3E <- ggarrange(b31, b32, b33, b34, b35, b36)
annotate_figure(BootPlot3E, top = text_grob("Bootstrap samples of Cognitive Sensitivity correlations", color = "black", 
                                         face = "bold", size = 14)) 

ggsave(here("figs", "bootplot4.png"), height = 8, width = 8, dpi = 300)

```

Now we calculate and plot the Bayes factors for the correlations: 
```{r}

# Bayes factor is estimated  and plots are saved: 
# Metacognitive sensitivity 
bf1<- bayes(corr$mda_memory, corr$mda_Calories)
ggsave(here("figs","bayes", "mda_Mem_cal.png"))
bf2 <- bayes(corr$mda_memory, corr$mda_vision)
ggsave(here("figs","bayes", "mda_Mem_vis.png"))
bf3 <- bayes(corr$mda_memory, corr$mda_GDP)
ggsave(here("figs","bayes", "mda_Mem_gdp.png"))
bf4 <- bayes(corr$mda_GDP, corr$mda_vision)
ggsave(here("figs","bayes", "mda_gdp_vis.png"))
bf5 <- bayes(corr$mda_GDP, corr$mda_Calories)
ggsave(here("figs","bayes", "mda_gdp_cal.png"))
bf6 <- bayes(corr$mda_Calories, corr$mda_vision)
ggsave(here("figs","bayes", "mda_cal_vis.png"))
 
#Metacognitive Efficiency
bf11 <- bayes(corr1$mratio_memory, corr1$mratio_Calories)
ggsave(here("figs","bayes", "mratio_Mem_cal.png"))
bf12 <- bayes(corr1$mratio_memory, corr1$mratio_vision)
ggsave(here("figs","bayes", "mratio_Mem_vis.png"))
bf13 <- bayes(corr1$mratio_memory, corr1$mratio_GDP)
ggsave(here("figs","bayes", "mratio_Mem_gdp.png"))
bf14 <- bayes(corr1$mratio_GDP, corr1$mratio_vision)
ggsave(here("figs","bayes", "mratio_gdp_vis.png"))
bf15 <- bayes(corr1$mratio_GDP, corr1$mratio_Calories)
ggsave(here("figs","bayes", "mratio_gdp_cal.png"))
bf16 <- bayes(corr1$mratio_Calories, corr1$mratio_vision)
ggsave(here("figs","bayes", "mratio_cal_vis.png"))

#Metacognitive bias 
bf21 <- bayes(corr2$avg_conf_memory, corr2$avg_conf_Calories)
ggsave(here("figs","bayes", "avgconf_Mem_cal.png"))
bf22 <- bayes(corr2$avg_conf_memory, corr2$avg_conf_vision)
ggsave(here("figs","bayes", "avgconf_Mem_vis.png"))
bf23 <- bayes(corr2$avg_conf_memory, corr2$avg_conf_GDP)
ggsave(here("figs","bayes", "avgconf_Mem_gdp.png"))
bf24 <- bayes(corr2$avg_conf_GDP, corr2$avg_conf_vision)
ggsave(here("figs","bayes", "avgconf_gdp_vis.png"))
bf25 <- bayes(corr2$avg_conf_GDP, corr2$avg_conf_Calories)
ggsave(here("figs","bayes", "avgconf_gdp_cal.png"))
bf26 <- bayes(corr2$avg_conf_Calories, corr2$avg_conf_vision)
ggsave(here("figs","bayes", "avgconf_cal_vis.png"))

#Cognitive Sensitivity
bf31 <- bayes(corr3$da_memory, corr3$da_Calories) 
ggsave(here("figs","bayes", "cogsen_Mem_calE.png"))
bf32 <- bayes(corr3$da_memory, corr3$da_vision)
ggsave(here("figs","bayes", "cogsen_Mem_visE.png"))
bf33 <- bayes(corr3$da_memory, corr3$da_GDP) 
ggsave(here("figs","bayes", "cogsen_Mem_gdpE.png"))
bf34 <- bayes(corr3$da_GDP, corr3$da_vision)
ggsave(here("figs","bayes", "cogsen_gdp_visE.png"))
bf35 <- bayes(corr3$da_GDP, corr3$da_Calories) 
ggsave(here("figs","bayes", "cogsen_gdp_calE.png"))
bf36 <- bayes(corr3$da_Calories, corr3$da_vision) 
ggsave(here("figs","bayes", "cogsen_cal_visE.png"))


#Make the APA tables: 
BayesSen <- data.frame(Pair=character(),
  `Bayes Factor`=double())
BayesEff <- data.frame( Pair=character(),
  `Bayes Factor`=double())
BayesBia <- data.frame( Pair=character(),
  `Bayes Factor`=double())
BayesCog <- data.frame( Pair=character(),
  `Bayes Factor`=double())

BayesSen <- BayesSen %>% rename( "Bayes Factor"= Bayes.Factor)
BayesEff <- BayesEff %>% rename( "Bayes Factor"= Bayes.Factor)
BayesBia <- BayesBia %>% rename( "Bayes Factor"= Bayes.Factor)
BayesCog <- BayesCog %>% rename( "Bayes Factor"= Bayes.Factor)

BayesSen[1,] <-list(paste0('Memory & Calories'), paste0(round(bf1@bayesFactor$bf,3))) 
BayesSen[2,] <-list(paste0('Memory & Vision'), paste0(round(bf2@bayesFactor$bf,3))) 
BayesSen[3,] <-list(paste0('Memory & GDP'), paste0(round(bf3@bayesFactor$bf,3))) 
BayesSen[4,] <-list(paste0('GDP & Calories'), paste0(round(bf4@bayesFactor$bf,3))) 
BayesSen[5,] <-list(paste0('Vision & Calories'), paste0(round(bf5@bayesFactor$bf,3))) 

BayesEff[1,] <-list(paste0('Memory & Calories'), paste0(round(bf11@bayesFactor$bf,3))) 
BayesEff[2,] <-list(paste0('Memory & Vision'), paste0(round(bf12@bayesFactor$bf,3))) 
BayesEff[3,] <-list(paste0('Memory & GDP'), paste0(round(bf13@bayesFactor$bf,3))) 
BayesEff[4,] <-list(paste0('GDP & Calories'), paste0(round(bf14@bayesFactor$bf,3))) 
BayesEff[5,] <-list(paste0('Vision & Calories'), paste0(round(bf15@bayesFactor$bf,3))) 

BayesBia[1,] <-list(paste0('Memory & Calories'), paste0(round(bf21@bayesFactor$bf,3))) 
BayesBia[2,] <-list(paste0('Memory & Vision'), paste0(round(bf22@bayesFactor$bf,3))) 
BayesBia[3,] <-list(paste0('Memory & GDP'), paste0(round(bf23@bayesFactor$bf,3))) 
BayesBia[4,] <-list(paste0('GDP & Calories'), paste0(round(bf24@bayesFactor$bf,3))) 
BayesBia[5,] <-list(paste0('Vision & Calories'), paste0(round(bf25@bayesFactor$bf,3))) 

BayesCog[1,] <-list(paste0('Memory & Calories'), paste0(round(bf31@bayesFactor$bf,3))) 
BayesCog[2,] <-list(paste0('Memory & Vision'), paste0(round(bf32@bayesFactor$bf,3))) 
BayesCog[3,] <-list(paste0('Memory & GDP'), paste0(round(bf33@bayesFactor$bf,3))) 
BayesCog[4,] <-list(paste0('GDP & Calories'), paste0(round(bf34@bayesFactor$bf,3))) 
BayesCog[5,] <-list(paste0('Vision & Calories'), paste0(round(bf35@bayesFactor$bf,3))) 

```

The same but EXCLUDE participants with out Mratio outliers or where Mratio could not be estimated 
```{r}

#exclude those where mratio could not be estimated (MLE):  
metadata_excMratio <- metadata_exc%>%filter(mratio!="NaN")

#mratio
metadata_excMratio <- metadata_excMratio%>%
  group_by(modality) %>%
  mutate(mratio = remove_outliers_robust(mratio))

metadata_excMratio <- na.omit(metadata_excMratio)

#Pivot: 
fit_data_wideExc <- metadata_excMratio %>% pivot_wider(
  names_from = modality,
  values_from = c(da, mda, mratio, c, avg_conf)
)

# Each correlation pair is estimated for Metacognitive sensitivity: 
corrE <- fit_data_wideExc %>%
  na.omit() %>%
  select(starts_with("mda"))
res1E <- corci(corrE$mda_memory, corrE$mda_Calories, method="spearman")
res2E <- corci(corrE$mda_memory, corrE$mda_vision, method="spearman")
res3E <- corci(corrE$mda_memory, corrE$mda_GDP, method="spearman")
res4E <- corci(corrE$mda_GDP, corrE$mda_vision, method="spearman")
res5E <- corci(corrE$mda_GDP, corrE$mda_Calories, method="spearman")
res6E <- corci(corrE$mda_Calories, corrE$mda_vision, method="spearman")

# Each correlation pair is estimated for efficiency: 
corr1E<- fit_data_wideExc %>%
  na.omit() %>%
  select(starts_with("mratio"))
res1.1E <- corci(corr1E$mratio_memory, corr1E$mratio_Calories, method="spearman")
res1.2E <- corci(corr1E$mratio_memory, corr1E$mratio_vision, method="spearman")
res1.3E <- corci(corr1E$mratio_memory, corr1E$mratio_GDP, method="spearman")
res1.4E <- corci(corr1E$mratio_GDP, corr1E$mratio_vision, method="spearman")
res1.5E <- corci(corr1E$mratio_GDP, corr1E$mratio_Calories, method="spearman")
res1.6E <- corci(corr1E$mratio_Calories, corr1E$mratio_vision, method="spearman")

# Each correlation pair is estimated for bias: 
corr2E <- fit_data_wideExc %>%
  na.omit() %>%
  select(starts_with("avg"))
res2.1E <- corci(corr2E$avg_conf_memory, corr2E$avg_conf_Calories, method="spearman")
res2.2E <- corci(corr2E$avg_conf_memory, corr2E$avg_conf_vision, method="spearman")
res2.3E <- corci(corr2E$avg_conf_memory, corr2E$avg_conf_GDP, method="spearman")
res2.4E <- corci(corr2E$avg_conf_GDP, corr2E$avg_conf_vision, method="spearman")
res2.5E <- corci(corr2E$avg_conf_GDP, corr2E$avg_conf_Calories, method="spearman")
res2.6E <- corci(corr2E$avg_conf_Calories, corr2E$avg_conf_vision, method="spearman")

# Each correlation pair is estimated for Cognitive sensitivity: 
corr3E <- fit_data_wideExc %>%
  na.omit() %>%
  select(starts_with("da"))
res31E <- corci(corr3E$da_memory, corr3E$da_Calories, method="spearman")
res32E <- corci(corr3E$da_memory, corr3E$da_vision, method="spearman")
res33E <- corci(corr3E$da_memory, corr3E$da_GDP, method="spearman")
res34E <- corci(corr3E$da_GDP, corr3E$da_vision, method="spearman")
res35E <- corci(corr3E$da_GDP, corr3E$da_Calories, method="spearman")
res36E <- corci(corr3E$da_Calories, corr3E$da_vision, method="spearman")

#Table with correlation coefficents for all pairwise correlations: 
corrtableE <- data.frame(Metric=character(),
                 MemCalCoef=double(),
                 CI_lowerMC=double(),
                 CI_upperMC=double(),
                 P_valueMC=double(),
                 MemVisCoef=double(),
                 CI_lowerMV=double(),
                 CI_upperMV=double(),
                 P_valueMV=double(),
                 MemGDPCoef=double(),
                 CI_lowerMG=double(),
                 CI_upperMG=double(),
                 P_valueMG=double(),
                 GDPVisCoef=double(),
                 CI_lowerGS=double(),
                 CI_upperGS=double(),
                 P_valueGS=double(),
                 GDPCalCoef=double(),
                 CI_lowerGC=double(),
                 CI_upperGC=double(),
                 P_valueGC=double(),
                 CalVisCoef=double(),
                 CI_lowerCV=double(),
                 CI_upperCV=double(),
                 P_valueCV=double(),
                stringsAsFactors=FALSE)

#Insert vaules in dataframe: 
corrtableE[1,] <- list("Meta-d",res1E$estimate,res1E$conf.int[1], res1E$conf.int[2], res1E$p.value,
                       res2E$estimate,res2E$conf.int[1], res2E$conf.int[2], res2E$p.value,
                       res3E$estimate,res3E$conf.int[1], res3E$conf.int[2], res3E$p.value,
                       res4E$estimate,res4E$conf.int[1], res4E$conf.int[2], res4E$p.value,
                       res5E$estimate,res5E$conf.int[1], res5E$conf.int[2], res5E$p.value,
                       res6E$estimate,res6E$conf.int[1], res6E$conf.int[2], res6E$p.value)
corrtableE[2,] <- list("Mratio",res1.1E$estimate,res1.1E$conf.int[1], res1.1E$conf.int[2],
                      res1.1E$p.value, res1.2E$estimate, res1.2E$conf.int[1], res1.2E$conf.int[2],
                      res1.2E$p.value, res1.3E$estimate, res1.3E$conf.int[1], res1.3E$conf.int[2],
                      res1.3E$p.value, res1.4E$estimate, res1.4E$conf.int[1], res1.4E$conf.int[2],
                      res1.4E$p.value, res1.5E$estimate, res1.5E$conf.int[1], res1.5E$conf.int[2],
                      res1.5E$p.value, res1.6E$estimate, res1.6E$conf.int[1], res1.6E$conf.int[2],
                      res1.6E$p.value)

corrtableE[3,] <- list("Bias",res1E$estimate,res2.1E$conf.int[1], res2.1E$conf.int[2],
                      res2.1E$p.value,res2.2E$estimate,res2.2E$conf.int[1], res2.2E$conf.int[2],
                      res2.2E$p.value,res2.3E$estimate,res2.3E$conf.int[1], res2.3E$conf.int[2], 
                      res2.3E$p.value,res2.4E$estimate,res2.4E$conf.int[1], res2.4E$conf.int[2], 
                      res2.4E$p.value,res2.5E$estimate,res2.5E$conf.int[1], res2.5E$conf.int[2],
                      res2.5E$p.value,res2.6E$estimate,res2.6E$conf.int[1], res2.6E$conf.int[2],
                      res2.6E$p.value)
corrtableE[4,] <- list("d'",res31E$estimate,res31E$conf.int[1], res31E$conf.int[2], res31E$p.value,
                       res32E$estimate,res32E$conf.int[1], res32E$conf.int[2], res32E$p.value,
                       res33E$estimate,res33E$conf.int[1], res33E$conf.int[2], res33E$p.value,
                       res34E$estimate,res34E$conf.int[1], res34E$conf.int[2], res34E$p.value,
                       res35E$estimate,res35E$conf.int[1], res35E$conf.int[2], res35E$p.value,
                       res36E$estimate,res36E$conf.int[1], res36E$conf.int[2], res36E$p.value)

head(corrtableE)


```

Plot the bootstrap samples of the correlations: GRusselete 
```{r}

b1E <- plotBoot(res1E) + ggtitle("Memory and Calories")
b2E <- plotBoot(res2E) + ggtitle("Memory and Vision")
b3E <- plotBoot(res3E) + ggtitle("Memory and GDP")
b4E <- plotBoot(res4E) + ggtitle("GDP and Vision")
b5E <- plotBoot(res5E) + ggtitle("GDP and Calories")
b6E <- plotBoot(res6E) + ggtitle("Vision and Calories")
BootPlot1E <- ggarrange(b1E, b2E, b3E, b4E, b5E, b6E)
annotate_figure(BootPlot1E, top = text_grob("Bootstrap samples of Meta-d' correlations", color = "black", 
                                         face = "bold", size = 14))  

ggsave(here("figs", "bootplot1E.png"), height = 8, width = 8, dpi = 300)

b11E <- plotBoot(res1.1E) + ggtitle("Memory and Calories")
b12E <- plotBoot(res1.2E) + ggtitle("Memory and Vision")
b13E <- plotBoot(res1.3E) + ggtitle("Memory and GDP")
b14E <- plotBoot(res1.4E) + ggtitle("GDP and Vision")
b15E <- plotBoot(res1.5E) + ggtitle("GDP and Calories")
b16E <- plotBoot(res1.6E) + ggtitle("Vision and Calories")
BootPlot2E <- ggarrange(b11E, b12E, b13E, b14E, b15E, b16E)
annotate_figure(BootPlot2E, top = text_grob("Bootstrap samples of Mratio correlations Efficiency", color = "black", 
                                         face = "bold", size = 14))  

ggsave(here("figs", "bootplot2E.png"), height = 8, width = 8, dpi = 300)

b21E <- plotBoot(res2.1E) + ggtitle("Memory and Calories")
b22E <- plotBoot(res2.2E) + ggtitle("Memory and Vision")
b23E <- plotBoot(res2.3E) + ggtitle("Memory and GDP")
b24E <- plotBoot(res2.4E) + ggtitle("GDP and Vision")
b25E <- plotBoot(res2.5E) + ggtitle("GDP and Calories")
b26E <- plotBoot(res2.6E) + ggtitle("Vision and Calories")
BootPlot3E <- ggarrange(b21E, b22E, b23E, b24E, b25E, b26E)
annotate_figure(BootPlot3E, top = text_grob("Bootstrap samples of Meta-bias correlations", color = "black", 
                                         face = "bold", size = 14)) 

ggsave(here("figs", "bootplot3E.png"), height = 8, width = 8, dpi = 300)

b31E <- plotBoot(res31E) + ggtitle("Memory and Calories")
b32E <- plotBoot(res32E) + ggtitle("Memory and Vision")
b33E <- plotBoot(res33E) + ggtitle("Memory and GDP")
b34E <- plotBoot(res34E) + ggtitle("GDP and Vision")
b35E <- plotBoot(res35E) + ggtitle("GDP and Calories")
b36E <- plotBoot(res36E) + ggtitle("Vision and Calories")
BootPlot3E <- ggarrange(b31E, b32E, b33E, b34E, b35E, b36E)
annotate_figure(BootPlot3E, top = text_grob("Bootstrap samples of Cognitive Sensitivity correlations", color = "black", 
                                         face = "bold", size = 14)) 

ggsave(here("figs", "bootplot4E.png"), height = 8, width = 8, dpi = 300)
```


Now we calculate and plot the Bayes factors for the correlations: 
```{r}

# Bayes factor is estimated  and plots are saved: 
# Metacognitive sensitivity 
bf1E<- bayes(corrE$mda_memory, corrE$mda_Calories) 
ggsave(here("figs","bayes", "mda_Mem_calE.png"))
bf2E <- bayes(corrE$mda_memory, corrE$mda_vision) 
ggsave(here("figs","bayes", "mda_Mem_visE.png"))
bf3E <- bayes(corrE$mda_memory, corrE$mda_GDP) 
ggsave(here("figs","bayes", "mda_Mem_gdpE.png"))
bf4E <- bayes(corrE$mda_GDP, corrE$mda_vision) 
ggsave(here("figs","bayes", "mda_gdp_visE.png"))
bf5E <- bayes(corrE$mda_GDP, corrE$mda_Calories) 
ggsave(here("figs","bayes", "mda_gdp_calE.png"))
bf6E <- bayes(corrE$mda_Calories, corrE$mda_vision) 
ggsave(here("figs","bayes", "mda_cal_visE.png"))
 
#Metacognitive Efficiency
bf11E <- bayes(corr1E$mratio_memory, corr1E$mratio_Calories) 
ggsave(here("figs","bayes", "mratio_Mem_calE.png"))
bf12E <- bayes(corr1E$mratio_memory, corr1E$mratio_vision) 
ggsave(here("figs","bayes", "mratio_Mem_visE.png"))
bf13E <- bayes(corr1E$mratio_memory, corr1E$mratio_GDP) 
ggsave(here("figs","bayes", "mratio_Mem_gdpE.png"))
bf14E <- bayes(corr1E$mratio_GDP, corr1E$mratio_vision) 
ggsave(here("figs","bayes", "mratio_gdp_visE.png"))
bf15E <- bayes(corr1E$mratio_GDP, corr1E$mratio_Calories) 
ggsave(here("figs","bayes", "mratio_gdp_calE.png"))
bf16E <- bayes(corr1E$mratio_Calories, corr1E$mratio_vision)
ggsave(here("figs","bayes", "mratio_cal_visE.png"))

#Metacognitive bias 
bf21E <- bayes(corr2E$avg_conf_memory, corr2E$avg_conf_Calories) 
ggsave(here("figs","bayes", "avgconf_Mem_calE.png"))
bf22E <- bayes(corr2E$avg_conf_memory, corr2E$avg_conf_vision)
ggsave(here("figs","bayes", "avgconf_Mem_visE.png"))
bf23E <- bayes(corr2E$avg_conf_memory, corr2E$avg_conf_GDP) 
ggsave(here("figs","bayes", "avgconf_Mem_gdpE.png"))
bf24E <- bayes(corr2E$avg_conf_GDP, corr2E$avg_conf_vision)
ggsave(here("figs","bayes", "avgconf_gdp_visE.png"))
bf25E <- bayes(corr2E$avg_conf_GDP, corr2E$avg_conf_Calories) 
ggsave(here("figs","bayes", "avgconf_gdp_calE.png"))
bf26E <- bayes(corr2E$avg_conf_Calories, corr2E$avg_conf_vision) 
ggsave(here("figs","bayes", "avgconf_cal_visE.png"))

#Cognitive Sensitivity
bf31E <- bayes(corr3E$da_memory, corr3E$da_Calories) 
ggsave(here("figs","bayes", "cogsen_Mem_calE.png"))
bf32E <- bayes(corr3E$da_memory, corr3E$da_vision)
ggsave(here("figs","bayes", "cogsen_Mem_visE.png"))
bf33E <- bayes(corr3E$da_memory, corr3E$da_GDP) 
ggsave(here("figs","bayes", "cogsen_Mem_gdpE.png"))
bf34E <- bayes(corr3E$da_GDP, corr3E$da_vision)
ggsave(here("figs","bayes", "cogsen_gdp_visE.png"))
bf35E <- bayes(corr3E$da_GDP, corr3E$da_Calories) 
ggsave(here("figs","bayes", "cogsen_gdp_calE.png"))
bf36E <- bayes(corr3E$da_Calories, corr3E$da_vision) 
ggsave(here("figs","bayes", "cogsen_cal_visE.png"))

#Make the APA tables: 
BayesSenE <- data.frame(Pair=character(),
  `Bayes Factor`=double())
BayesEffE <- data.frame( Pair=character(),
  `Bayes Factor`=double())
BayesBiaE <- data.frame( Pair=character(),
  `Bayes Factor`=double())
BayesCogE <- data.frame( Pair=character(),
  `Bayes Factor`=double())

BayesSenE <- BayesSenE %>% rename( "Bayes Factor"= Bayes.Factor)
BayesEffE <- BayesEffE %>% rename( "Bayes Factor"= Bayes.Factor)
BayesBiaE <- BayesBiaE %>% rename( "Bayes Factor"= Bayes.Factor)
BayesCogE <- BayesCogE %>% rename( "Bayes Factor"= Bayes.Factor)

BayesSenE[1,] <-list(paste0('Memory & Calories'), paste0(round(bf1E@bayesFactor$bf,3))) 
BayesSenE[2,] <-list(paste0('Memory & Vision'), paste0(round(bf2E@bayesFactor$bf,3))) 
BayesSenE[3,] <-list(paste0('Memory & GDP'), paste0(round(bf3E@bayesFactor$bf,3))) 
BayesSenE[4,] <-list(paste0('GDP & Calories'), paste0(round(bf4E@bayesFactor$bf,3))) 
BayesSenE[5,] <-list(paste0('Vision & Calories'), paste0(round(bf5E@bayesFactor$bf,3))) 

BayesEffE[1,] <-list(paste0('Memory & Calories'), paste0(round(bf11E@bayesFactor$bf,3))) 
BayesEffE[2,] <-list(paste0('Memory & Vision'), paste0(round(bf12E@bayesFactor$bf,3))) 
BayesEffE[3,] <-list(paste0('Memory & GDP'), paste0(round(bf13E@bayesFactor$bf,3))) 
BayesEffE[4,] <-list(paste0('GDP & Calories'), paste0(round(bf14E@bayesFactor$bf,3))) 
BayesEffE[5,] <-list(paste0('Vision & Calories'), paste0(round(bf15E@bayesFactor$bf,3))) 

BayesBiaE[1,] <-list(paste0('Memory & Calories'), paste0(round(bf21E@bayesFactor$bf,3))) 
BayesBiaE[2,] <-list(paste0('Memory & Vision'), paste0(round(bf22E@bayesFactor$bf,3))) 
BayesBiaE[3,] <-list(paste0('Memory & GDP'), paste0(round(bf23E@bayesFactor$bf,3))) 
BayesBiaE[4,] <-list(paste0('GDP & Calories'), paste0(round(bf24E@bayesFactor$bf,3))) 
BayesBiaE[5,] <-list(paste0('Vision & Calories'), paste0(round(bf25E@bayesFactor$bf,3))) 

BayesCogE[1,] <-list(paste0('Memory & Calories'), paste0(round(bf31E@bayesFactor$bf,3))) 
BayesCogE[2,] <-list(paste0('Memory & Vision'), paste0(round(bf32E@bayesFactor$bf,3))) 
BayesCogE[3,] <-list(paste0('Memory & GDP'), paste0(round(bf33E@bayesFactor$bf,3))) 
BayesCogE[4,] <-list(paste0('GDP & Calories'), paste0(round(bf34E@bayesFactor$bf,3))) 
BayesCogE[5,] <-list(paste0('Vision & Calories'), paste0(round(bf35E@bayesFactor$bf,3))) 

```

FROM HERE ON I AM ONLY USING THE DATA WHERE MRATIO OUTLIERS ARE EXCLUDED. 

Here we plot the Figures from the Paper: 


Rearrange accuracy data for plotting summary variables
```{r}
 
#make the four bins: 
metadataPlot <- metadata %>%group_by(subject) %>% 
mutate(trial_number = row_number()) %>%
group_by(subject) #create a trial number column
  
#split in the four bins according to task 
metadataPlot <- metadataPlot %>%
    group_by(modality) %>%
    mutate(trial_bin = ntile(trial_number, n = 4)) 
  
#Summarise means for each bin and modality
metadataPlotMean <- metadataPlot %>%
group_by(trial_bin, modality) %>%
summarise(mean.acc = mean(accuracy),
          sd.acc = sd(accuracy), n.acc = n_distinct(subject)) %>%
mutate(se.acc = sd.acc / sqrt(n.acc),
         lower.ci.acc = mean.acc - qt(1 - (0.05 / 2), n.acc - 1) * se.acc,
         upper.ci.acc = mean.acc + qt(1 - (0.05 / 2), n.acc - 1) * se.acc) %>%
ungroup()


#Average confidence across domains, split by correct and incorrect trials
#split by correct and incorrect:
tmp_data <- metadata  %>%
   mutate(accuracy = factor(accuracy)) %>%
  mutate(accuracy = recode_factor(accuracy, '1' = "Hits", '0' = "Misses"))

#Average confidence for Correct trials:
ConfByError <- tmp_data  %>%
  group_by(subject, modality, accuracy) %>% 
  summarise(avgCF_Corr=mean(confidence, na_rm=TRUE)) 

```


Figure 2: d' and group staircase
```{r}
# Figure2 

#Plot of d' without outliers: 

p1<-ggplot(metadata_excMratio, aes(x = modality, y = da, fill= modality)) +
   geom_half_point(range_scale = 8/10, shape = 21, alpha = 1/10, side = "l")+
   geom_half_boxplot(outlier.shape = NA, notch = TRUE, width = 1/4,
                     alpha = 1, color = "black", side = "r")+
  guides(fill="none") +
  ggtitle("Cognitive Sensitivity") +  labs(y = "D-prime", x = "Modality") + 
  theme_cowplot() + 
  scale_fill_manual(values = colors)+
  scale_x_discrete(labels = c("Calories", "GDP","Memory", "Vision")) +
  theme(legend.position = "none", 
        # aspect.ratio = 1,
        plot.title = element_text(size = 12), 
        axis.text=element_text(size=10),
        axis.title=element_text(size=10,face="bold"))

#Plot of group-level Staircases: (includes everyone - as beefore MLE)
pd <- position_dodge(0.1)
p2 <- ggplot(metadataPlotMean, aes(x = trial_bin, y = mean.acc, group = modality, color= modality)) +
  geom_line(position = pd) +
  geom_point(position = pd) + 
  geom_errorbar(aes(ymin=lower.ci.acc,  ymax = upper.ci.acc),
                size = 1, width=0, position = pd, alpha = 1/4) +
  ylab("Average Accuracy")+
  xlab("Task Quarter") + 
  theme_cowplot() +
  ggtitle("Group-level Staircases") + 
  scale_linetype_discrete(name = "Modality", breaks = c("Calories", "GDP","Memory", "Vision")) +
  scale_x_continuous(labels = label_ordinal())+
  scale_y_continuous(breaks = seq(.6, .9, .1),
                     labels = scales::percent,
                     limits = c(.6, .9)) +
  theme(legend.title = element_blank(), 
       # aspect.ratio = 1,
        legend.position = c(1, 1), 
        legend.justification = c(1,1),
        legend.text = element_text(size = 10), 
        legend.direction = "horizontal", 
        plot.title = element_text(size = 12), 
        axis.text=element_text(size=10),
        axis.title=element_text(size=10,face="bold")) +
  guides(colour = guide_legend(nrow = 2))+
  scale_colour_manual(values = colors)

f2 <- p1 + p2 

f2 <- f2 +  plot_annotation(tag_levels = 'A',   tag_suffix = ')') & 
  theme(plot.tag = element_text(size = 12))

f2

# Again includes everything - again before MLE. 
p3 <- ggplot(data=ConfByError, 
       aes(x = modality, y = avgCF_Corr, fill=modality, shape = accuracy)) + 

  geom_half_point(aes(color = modality), range_scale = 1/2, alpha = 1/10,
                  side = "l", position = position_dodge(c(3/4,3/4)))+
  geom_half_boxplot(outlier.shape = NA, 
                    side = "r", notch = TRUE, width = 1/2,
                    alpha = 1, color = "black", show.legend = FALSE, 
                    position = position_dodge(c(3/4,3/4)))+
  theme_cowplot() +
  labs(y = "Average Confidence",
        x = "Modality", 
        fill = "Legend") + 
  scale_x_discrete(labels = c("Calories", "GDP","Memory", "Vision"))+ 
  scale_shape_manual(values=c(1, 4), guide = "legend")+
  guides(shape = guide_legend(override.aes = list(color = "black", alpha = 1))) +
  scale_fill_manual(values = colors, guide = "none")+
  scale_color_manual(values = colors, guide = "none")+
  scale_y_continuous(breaks = seq(1, 7, 1),
                     limits = c(.5, 7)) +
  ggtitle("Confidence by Accuracy") +
    theme(legend.position = c(.01,.05),
          legend.spacing.y = unit(1, "mm"),
          legend.spacing.x = unit(2, "mm"),
          legend.text.align = 0,
          legend.box.just = "center",
          #aspect.ratio = 1,
          legend.direction="horizontal",
          legend.background = element_blank(),
          legend.text = element_text(size = 10 ), 
          legend.title = element_blank(), 
          plot.title = element_text(size = 12), 
          axis.text=element_text(size=10),
          axis.title=element_text(size=10,face="bold")) 
# M-ratio across modalities:


p4<-ggplot(metadata_excMratio, aes(x = modality, y = mratio, fill= modality)) +
    geom_hline(yintercept = 1, linetype="dashed", color = "black", size=.5)+
    aes(ymin = 0) +
    geom_blank() +
   geom_half_point(range_scale = 8/10, shape = 21, alpha = 1/10, side = "l")+
   geom_half_boxplot(outlier.shape = NA, notch = TRUE, width = 1/4, alpha = 1,
                     color = "black", side = "r")+
   guides(color="none") +
  ggtitle("Metacognitive Efficiency")+
  labs(y = "Meta-d'/d'", x = "Modality", color = "Legend") + 
  scale_fill_manual(values = colors)+
  scale_x_discrete(labels = c("Calories", "GDP","Memory", "Vision")) +
    scale_y_continuous(breaks = seq(-2, 4, 1),
                     limits = c(-2, 4)) +
   theme_cowplot() +
   theme(legend.position = "none", 
         #aspect.ratio = 1, 
         plot.title = element_text(size = 12), 
        axis.text=element_text(size=10),
        axis.title=element_text(size=10,face="bold")) 
  
  
 
  
f3 <- p3 + p4  +  plot_annotation(tag_levels = 'A',   tag_suffix = ')') & 
  theme(plot.tag = element_text(size = 10))

  f3
  


f3a <- (p1 + p2) / (p3 + p4) +  plot_annotation(tag_levels = 'A',   tag_suffix = ')') & 
  theme(plot.tag = element_text(size = 10))

f3a

ggsave(here("figs", "Figure 2.png"), height = 16.8, width = 16.8, units = "cm", dpi = 300)  


```


Figure 3: Scatter Plot MLE estimation
```{r}

#The scatter plot for the MLE estimation of Mratio: 
#Metacognitive Efficiency
#Indicate the estimated correlations: 

S1title <- paste("r =",round(res1.1$estimate, digits=3))
S2title <- paste("r =",round(res1.2$estimate, digits=3))
S3title <- paste("r =",round(res1.3$estimate, digits=3))
S4title <- paste("r =",round(res1.4$estimate, digits=3))
S5title <- paste("r =",round(res1.5$estimate, digits=3))
S6title <- paste("r =",round(res1.6$estimate, digits=3))


scat2 <- as_tibble(corr1)
s11 <- scatter(scat2, scat2$mratio_memory, scat2$mratio_Calories) + theme(plot.title = element_text( size = 10)) + scale_y_continuous("Calories")+scale_x_continuous("Memory") + ggtitle(paste(S1title))
s12 <- scatter(scat2, scat2$mratio_memory, scat2$mratio_vision) + theme(plot.title = element_text( size = 10)) + scale_y_continuous("Vision")+scale_x_continuous("Memory") + ggtitle(paste(S2title))
s13 <- scatter(scat2, scat2$mratio_memory, scat2$mratio_GDP) + theme(plot.title = element_text( size = 10)) + scale_y_continuous("GDP")+scale_x_continuous("Memory") + ggtitle(paste(S3title))
s14 <- scatter(scat2, scat2$mratio_GDP, scat2$mratio_vision) +  theme(plot.title = element_text( size = 10)) +scale_y_continuous("Vision")+scale_x_continuous("GDP") + ggtitle(paste(S4title))
s15 <- scatter(scat2, scat2$mratio_GDP, scat2$mratio_Calories) + theme(plot.title = element_text( size = 10)) + scale_y_continuous("Calories")+ scale_x_continuous("GDP") + ggtitle(paste(S5title))
s16 <- scatter(scat2, scat2$mratio_Calories, scat2$mratio_vision) + theme(plot.title = element_text( size = 10)) + scale_y_continuous("Vision")+scale_x_continuous("Calories") + ggtitle(paste(S6title))

comPlot2 <- ggarrange(s11, s12, s13, s14, s15, s16) 
annotate_figure(comPlot2, top = text_grob("Metacognitive Efficiency", color = "black", 
                                         face = "bold", size = 14))    
  


```

Figure 3 without Mratio outliers: 
```{r}


S1Etitle <- paste("r =",round(res1.1E$estimate, digits=3))
S2Etitle <- paste("r =",round(res1.2E$estimate, digits=3))
S3Etitle <- paste("r =",round(res1.3E$estimate, digits=3))
S4Etitle <- paste("r =",round(res1.4E$estimate, digits=3))
S5Etitle <- paste("r =",round(res1.5E$estimate, digits=3))
S6Etitle <- paste("r =",round(res1.6E$estimate, digits=3))

#Plot the correlations: 
scat2E <- as_tibble(corr1E)
s11E <-scatter(scat2E, scat2E$mratio_memory, scat2E$mratio_Calories) + theme(plot.title = element_text( size = 13)) + scale_y_continuous("Calories")+scale_x_continuous("Memory") + ggtitle(paste(S1Etitle))

s12E <- scatter(scat2E, scat2E$mratio_memory, scat2E$mratio_vision) + theme(plot.title = element_text( size = 13)) +
  scale_y_continuous("Vision")+scale_x_continuous("Memory") + ggtitle(paste(S2Etitle))

s13E <- scatter(scat2E, scat2E$mratio_memory, scat2E$mratio_GDP) + theme(plot.title = element_text( size = 13)) +
  scale_y_continuous("GDP")+scale_x_continuous("Memory") + ggtitle(paste(S3Etitle))

s14E <- scatter(scat2E, scat2E$mratio_GDP, scat2E$mratio_vision) + theme(plot.title = element_text( size = 13)) +
  scale_y_continuous("Vision")+scale_x_continuous("GDP") + ggtitle(paste(S4Etitle))

s15E <- scatter(scat2E, scat2E$mratio_GDP, scat2E$mratio_Calories) + theme(plot.title = element_text( size = 13)) +
  scale_y_continuous("Calories")+ scale_x_continuous("GDP") + ggtitle(paste(S5Etitle))

s16E <- scatter(scat2E, scat2E$mratio_Calories, scat2E$mratio_vision) + theme(plot.title = element_text( size = 13)) + scale_y_continuous("Vision")+scale_x_continuous("Calories") + ggtitle(paste(S6Etitle))

comPlotE <- ggarrange(s11E, s12E, s13E, s14E, s15E, s16E) 
annotate_figure(comPlotE, top = text_grob("Maximum Likelihood Model", color = "black", face = "bold", size = 18))   
#figure 3 now without MLE mratio outliers: 
#Figure3E <- ggarrange(CorExcMLE, CorHi, ncol= 1, nrow=2)  
  #annotate_figure(Figure3E, top = text_grob("Figure 3", color = "black",face = "bold", size = 14))

ggsave(here("figs", "Figure 3 without Outliers.png"), height = 7, width = 12)

```

The plots for the hierarhical model - sample estimations of rho: + Combine the MLE from above
```{r}
#SEE document fit_hierarhical_metamodel

```

Now the tables from the paper: 

Averages of performance for descriptive statistics: Without MRATIO Outliers
```{r}
#Average everything and calculate standard deviations for the MLE model: 
metadata_avg <- metadata_excMratio %>% 
  group_by(modality) %>% 
  summarise(dprime=mean(da, na_rm=TRUE), 
            criterion=mean(c, na_rm=TRUE),
            metad=mean(mda, na_rm=TRUE),
            mratio1=mean(mratio, na_rm=TRUE),
            avg_conf1=mean(avg_conf, na_rm=TRUE),
            dprime_sd=sd(da),
            criterion_sd=sd(c),
            metad_sd=sd(mda),
            mratio_sd=sd(mratio),
            avg_conf_sd=sd(avg_conf), 
            n1 = n()
            )  %>% mutate(Modality=c("Calories", "GDP", "Memory", "Vision")) %>%
  select(-modality)


#load hierarhical fit:
 
#For Astrid: 
 output <- readRDS("C:/Users/Astrid/Documents/DomainGen/modelfit.RDS")
 
 fit_filename = "/home/micah/metad_groupfit.RDS" ## change this to the correct place! 
 
 if (file.exists(fit_filename) == 1 ) {
 
 output <- readRDS(fit_filename)
   
 } else{
   
 message("OBS: You need to fit the hierarhical model using 'fit_hierarhicical_metamodel.rmd' - this will take a LONG time")
}

 #Prepare the hierarhical fit for the figure: 
Value <- gelman.diag(output, confidence = 0.95)
Rhat <- data.frame(conv = Value$psrf)
 
 # Values (mean and CI)
Value <- summary(output)
stat <- data.frame(mean = Value$statistics[,"Mean"])
stat %<>%
  rownames_to_column(var = "name") %>% 
  cbind(CILow = Value$quantiles[,"2.5%"]) %>% 
  cbind(CIUp = Value$quantiles[,"97.5%"])

 # HDI function 
 HDI <- data.frame(HPDinterval(output, prob = 0.95))
 HDI %<>%
   rownames_to_column(var = "name")
 

#Fit stats summary. 
Fit <- stat %>%
   cbind(lower = HDI$lower,
         upper = HDI$upper,
        Rhat = Rhat[,1]) 

#Select Mratio and take the exponential of the value:
meanMratio <- Fit %>% filter(str_detect(name,"mu_logMratio")) %>%
  mutate(Hmratio=exp(mean), 
         lowerHDI=exp(lower),
         upperHDI=exp(upper)) %>% 
    mutate(Modality=c("Memory", "Calories", "GDP", "Vision"), 
           n2="319") %>%
  select(Modality, Hmratio, lowerHDI, upperHDI, n2)
                                    

#Load criterion and dprime - Astrid:
c1 <-readRDS("C:/Users/Astrid/Documents/DomainGen/fit_c1")
d1 <-readRDS("C:/Users/Astrid/Documents/DomainGen/fit_d1")

#Label tasks and pivot the vectors: 
c1 <- data.frame(c1)
d1 <- data.frame(d1)
c1 <- c1 %>% mutate (Memory=T1, Calories= T2, GDP = T3, Vision = T4, subject = row_number())%>% select(-T1, -T2, -T3, -T4)
d1 <- d1 %>% mutate (Memory=T1, Calories= T2, GDP = T3, Vision = T4, subject = row_number())%>% select(-T1, -T2, -T3, -T4)

c1l <- c1 %>% pivot_longer(
  cols = c("Memory", "Calories", "GDP", "Vision"), 
  names_to="Modality",
  values_to ="Criterion")

d1l <- d1 %>% pivot_longer(
  cols = c("Memory", "Calories", "GDP", "Vision"), 
  names_to="Modality",
  values_to ="d'")

#Summarise - mean and SD: 
c1l_avg <- c1l %>% 
  group_by(Modality) %>% 
  summarise(Hcriterion=mean(Criterion, na_rm=TRUE), 
            Hcriterion_sd=sd(Criterion), n3=n())

d1l_avg <- d1l %>% 
  group_by(Modality) %>% 
  summarise(Hdprime=mean(`d'`, na_rm=TRUE), 
            Hdprime_SD= sd(`d'`), n4=n())

#Join the two: 
HdcSum <- left_join(c1l_avg , d1l_avg , 
                     by=c("Modality"="Modality"))

#Joim Hier cognitive and metacognitive: 
MetaHier<- left_join(meanMratio , HdcSum , 
                     by=c("Modality"="Modality"))

#Join MLE and Hier: 
MetaSum <- left_join(MetaHier , metadata_avg , 
                     by=c("Modality"="Modality"))


         
         
head(MetaSum)
```

Table 1: Cognitive Descriptives. 
```{r}
#Descriptive Cognitive Performance Data: 
metadata_cog <- MetaSum %>% select(Modality, dprime, dprime_sd, criterion,  criterion_sd, Hdprime, Hdprime_SD, Hcriterion, Hcriterion_sd, n1, n2, n3, n4)

metadata_cog1 <- metadata_cog %>% select(Modality, n3, n4, starts_with("H")) 
metadata_cog2 <- metadata_cog %>% select(Modality, n1, dprime,dprime_sd, criterion,  criterion_sd) 

Cog12<- left_join(metadata_cog1 , metadata_cog2, 
                     by=c("Modality"="Modality"))

Cog12 <- Cog12 %>% add_row(Modality = "NA" ,.before=1) %>% add_row(Modality = "NA" ,.before=1)  %>% select(-n4)

#Number of decimals: 
Cog12 <- Cog12 %>% mutate_if(is.numeric, round, 2)

#Change to Characteris: 
Cog12 <- Cog12 %>%
  mutate_all(as.character)

#Add labels: 
Cog12[1,1] <- "Modality"
Cog12[1,2] <- "n"
Cog12[1,3] <- "d' (HMeta-d')"
Cog12[1,4] <- "d' (HMeta-d')"
Cog12[1,5] <- "Criterion (HMeta-d')"
Cog12[1,6] <- "Criterion (HMeta-d')"
Cog12[1,7] <- "n"
Cog12[1,8] <- "d' (MLE)"
Cog12[1,9] <- "d' (MLE)"
Cog12[1,10] <- "Criterion (MLE)"
Cog12[1,11] <- "Criterion (MLE)"
Cog12[2,3] <- "M"
Cog12[2,4] <- "SD"
Cog12[2,5] <- "M"
Cog12[2,6] <- "SD"
Cog12[2,8] <- "M"
Cog12[2,9] <- "SD"
Cog12[2,10] <- "M"
Cog12[2,11] <- "SD"

Cog12 <- Cog12 %>% select(Modality, n1, dprime, dprime_sd, criterion, criterion_sd, n3, Hdprime, Hdprime_SD, Hcriterion, Hcriterion_sd)

#Save as csv
write.csv(Cog12 ,file= here("tables", 'CogPer_MLEHier.csv'))

#APA
Des <-apa(Cog12, "Cognitive performance: MLE and Bayesian estimations")
Des

```
All MLE Correlations: WITHOUT MRATIO OUTLIERS AS EXCLUDED ABOVE 
```{r}

#combine upper and lower limit of CI into one. 
MLEcorr <- corrtableE %>% mutate(MC_CI = paste(round(corrtableE$CI_lowerMC,3), round(corrtableE$CI_upperMC,3), sep=";")) %>%
  mutate(MV_CI= paste(round(corrtableE$CI_lowerMV,3), round(corrtableE$CI_upperMV,3), sep=";")) %>%
  mutate(MG_CI= paste(round(corrtableE$CI_lowerMG,3), round(corrtableE$CI_upperMG,3), sep=";")) %>%
  mutate(GS_CI= paste(round(corrtableE$CI_lowerGS,3), round(corrtableE$CI_upperGS,3), sep=";")) %>%
  mutate(GC_CI= paste(round(corrtableE$CI_lowerGC,3), round(corrtableE$CI_upperGC,3), sep=";")) %>%
  mutate(CV_CI= paste(round(corrtableE$CI_lowerCV,3), round(corrtableE$CI_upperCV,3), sep=";")) 

#Select relevant columns 
MLEcorr <- MLEcorr %>% select(Metric, 
                            MemCalCoef, P_valueMC, MC_CI, 
                            MemVisCoef, P_valueMV, MV_CI, 
                            MemGDPCoef, P_valueMG, MG_CI, 
                            GDPVisCoef, P_valueGS, GS_CI,
                            GDPCalCoef, P_valueGC, GC_CI, 
                            CalVisCoef, P_valueCV, CV_CI
                            )
head(MLEcorr)
```

Table 2: Correlation of Cognitive Sensitivity 
```{r}

#d' correlation: 
table2 <- data.frame(Pair=character(),
                 r=double(),
                 p=double(),
                 'Conf Interval'=double(),
                stringsAsFactors=FALSE)

#Insert vaules in dataframe: 
table2[1,] <- list("Memory & Calories",MLEcorr$MemCalCoef[4],MLEcorr$P_valueMC[4], MLEcorr$MC_CI[4])
table2[2,] <- list("Memory & Vision",MLEcorr$MemVisCoef[4],MLEcorr$P_valueMV[4], MLEcorr$MV_CI[4])
table2[3,] <- list("Memory & GDP",MLEcorr$MemGDPCoef[4],MLEcorr$P_valueMG[4], MLEcorr$MG_CI[4])
table2[4,] <- list("GDP & Vision",MLEcorr$GDPVisCoef[4],MLEcorr$P_valueGS[4], MLEcorr$GS_CI[4])
table2[5,] <- list("GDP & Calories",MLEcorr$GDPCalCoef[4],MLEcorr$P_valueGC[4], MLEcorr$GC_CI[4])
table2[6,] <- list("Calories & Vision",MLEcorr$CalVisCoef[4],MLEcorr$P_valueCV[4], MLEcorr$CV_CI[4])

#Create table
CorT <- data.frame((matrix(NA, nrow=4, ncol=7)))

#Insert values in the table 
CorT[,1] <-metadata_cog2$Modality
CorT[,2] <-metadata_cog2$n1
CorT[,3] <-metadata_cog2$dprime
CorT[,4] <-metadata_cog2$dprime_sd
CorT[2,5] <- table2[1,2] # Mem & Cal
CorT[3,5] <- table2[3,2] # Mem & GDP
CorT[4,5] <- table2[2,2] # Mem & Vis
CorT[3,6] <- table2[5,2] # Cal & GDP
CorT[4,6] <- table2[6,2] # Cal & Vis
CorT[4,7] <- table2[4,2] # GDP & Vis

# None of them are significant, as can be seen in the dataframe 'table2' so I am not adding any *. 

#Number of decimals: 
CorT <- CorT %>% mutate_if(is.numeric, round, 3)

#Rename and select Columns: 
CorT <- CorT %>% mutate(Modality =X1, n=X2, M=X3, SD=X4, Memory = X5, Calories = X6, GDP =X7) %>%
  select(Modality, n, M, SD, Memory, Calories, GDP)

#Save as csv
write.csv(CorT ,file= here("tables", 'CogCor_MLE.csv'))


#APA format:
CorD <-apa(CorT, "Cognitive Sensitivity (d') descriptives and correlation: MLE")
CorD
```

Table 3: Metacognitive Correlation and descriptive: MLE - Efficiency
```{r}

#Table with correlation coefficents for all pairwise correlations: 
table3 <- data.frame(Pair=character(),
                 r=double(),
                 p=double(),
                 'Conf Interval'=double(),
                stringsAsFactors=FALSE)

#Insert vaules in dataframe: 
table3[1,] <- list("Memory & Calories",MLEcorr$MemCalCoef[2],MLEcorr$P_valueMC[2], MLEcorr$MC_CI[2])
table3[2,] <- list("Memory & Vision",MLEcorr$MemVisCoef[2],MLEcorr$P_valueMV[2], MLEcorr$MV_CI[2])
table3[3,] <- list("Memory & GDP",MLEcorr$MemGDPCoef[2],MLEcorr$P_valueMG[2], MLEcorr$MG_CI[2])
table3[4,] <- list("GDP & Vision",MLEcorr$GDPVisCoef[2],MLEcorr$P_valueGS[2], MLEcorr$GS_CI[2])
table3[5,] <- list("GDP & Calories",MLEcorr$GDPCalCoef[2],MLEcorr$P_valueGC[2], MLEcorr$GC_CI[2])
table3[6,] <- list("Calories & Vision",MLEcorr$CalVisCoef[2],MLEcorr$P_valueCV[2], MLEcorr$CV_CI[2])

#Create table
MLEMT <- data.frame((matrix(NA, nrow=4, ncol=7)))

#Insert values in the table 
MLEMT [,1] <-MetaSum$Modality
MLEMT [,2] <-MetaSum$n1
MLEMT [,3] <-paste0(round(MetaSum$mratio1,2))
MLEMT [,4] <-paste0(round(MetaSum$mratio_sd,2))
MLEMT [2,5] <- paste0(round(table3[1,2],3), "*") # Mem & Cal
MLEMT [3,5] <- paste0(round(table3[3,2],3), "*")# Mem & GDP
MLEMT [4,5] <- paste0(round(table3[2,2],3), "*") # Mem & Vis
MLEMT [3,6] <- paste0(round(table3[5,2],3))# Cal & GDP
MLEMT [4,6] <- paste0(round(table3[6,2],3), "*")# Cal & Vis
MLEMT [4,7] <- paste0(round(table3[4,2],3))# GDP & Vis

CorT[2,5] <- table2[1,2] # Mem & Cal
CorT[3,5] <- table2[3,2] # Mem & GDP
CorT[4,5] <- table2[2,2] # Mem & Vis
CorT[3,6] <- table2[5,2] # Cal & GDP
CorT[4,6] <- table2[6,2] # Cal & Vis
CorT[4,7] <- table2[4,2] # GDP & Vis

#  * : under 0.05 - can be seen in dataframe table3. 

#Rename and select Columns: 
MLEMT  <- MLEMT %>% mutate(Modality =X1, n=X2, M=X3, SD=X4, Memory = X5, Calories = X6, GDP =X7) %>%
  select(Modality, n, M, SD, Memory, Calories, GDP)


#Write csv
write.csv(MLEMT ,file= here("tables", 'EffCor_MLE.csv'))

#APA format:
CorEff<-apa(MLEMT, "Table 3: Correlation of Metacognitive Efficiency (meta-d'/d'): MLE")

CorEff

```

Table X: Metacognitive Correlation and descriptive: MLE - Bias
```{r}

#Table with correlation coefficents for all pairwise correlations: 
table3a <- data.frame(Pair=character(),
                 r=double(),
                 p=double(),
                 'Conf Interval'=double(),
                stringsAsFactors=FALSE)

#Insert vaules in dataframe: 
table3a[1,] <- list("Memory & Calories",MLEcorr$MemCalCoef[3],MLEcorr$P_valueMC[3], MLEcorr$MC_CI[3])
table3a[2,] <- list("Memory & Vision",MLEcorr$MemVisCoef[3],MLEcorr$P_valueMV[3], MLEcorr$MV_CI[3])
table3a[3,] <- list("Memory & GDP",MLEcorr$MemGDPCoef[3],MLEcorr$P_valueMG[3], MLEcorr$MG_CI[3])
table3a[4,] <- list("GDP & Vision",MLEcorr$GDPVisCoef[3],MLEcorr$P_valueGS[3], MLEcorr$GS_CI[3])
table3a[5,] <- list("GDP & Calories",MLEcorr$GDPCalCoef[3],MLEcorr$P_valueGC[3], MLEcorr$GC_CI[3])
table3a[6,] <- list("Calories & Vision",MLEcorr$CalVisCoef[3],MLEcorr$P_valueCV[3], MLEcorr$CV_CI[3])

#Create table
MLEBI <- data.frame((matrix(NA, nrow=4, ncol=7)))

#Insert values in the table 
MLEBI [,1] <-MetaSum$Modality
MLEBI [,2] <-MetaSum$n1
MLEBI [,3] <-paste0(round(MetaSum$avg_conf1,2))
MLEBI [,4] <-paste0(round(MetaSum$avg_conf_sd,2))
MLEBI [2,5] <- paste0(round(table3a[1,2],3), "***")# Mem & Cal
MLEBI [3,5] <- paste0(round(table3a[3,2],3), "***")# Mem & GDP
MLEBI [4,5] <- paste0(round(table3a[2,2],3), "***")# Mem & Vis
MLEBI [3,6] <- paste0(round(table3a[5,2],3), "***")# Cal & GDP
MLEBI [4,6] <- paste0(round(table3a[6,2],3), "***")# Cal & Vis
MLEBI [4,7] <- paste0(round(table3a[4,2],3), "***")# GDP & Vis
#  * : under 0.05 - can be seen in dataframe table3. 

#Rename and select Columns: 
MLEBI  <- MLEBI %>% mutate(Modality =X1, n=X2, M=X3, SD=X4, Memory = X5, Calories = X6, GDP =X7) %>%
  select(Modality, n, M, SD, Memory, Calories, GDP)


#Write csv
write.csv(MLEBI ,file= here("tables", 'BiasCor_MLE.csv'))

#APA format:
CorBia<-apa(MLEBI, "Table 3: Correlation of Metacognitive Bias")

CorBia

```
Table X: Metacognitive Correlation and descriptive: MLE - Sensitivity
```{r}

#Table with correlation coefficents for all pairwise correlations: 
table3b <- data.frame(Pair=character(),
                 r=double(),
                 p=double(),
                 'Conf Interval'=double(),
                stringsAsFactors=FALSE)

#Insert vaules in dataframe: 
table3b[1,] <- list("Memory & Calories",MLEcorr$MemCalCoef[1],MLEcorr$P_valueMC[1], MLEcorr$MC_CI[1])
table3b[2,] <- list("Memory & Vision",MLEcorr$MemVisCoef[1],MLEcorr$P_valueMV[1], MLEcorr$MV_CI[1])
table3b[3,] <- list("Memory & GDP",MLEcorr$MemGDPCoef[1],MLEcorr$P_valueMG[1], MLEcorr$MG_CI[1])
table3b[4,] <- list("GDP & Vision",MLEcorr$GDPVisCoef[1],MLEcorr$P_valueGS[1], MLEcorr$GS_CI[1])
table3b[5,] <- list("GDP & Calories",MLEcorr$GDPCalCoef[1],MLEcorr$P_valueGC[1], MLEcorr$GC_CI[1])
table3b[6,] <- list("Calories & Vision",MLEcorr$CalVisCoef[1],MLEcorr$P_valueCV[1], MLEcorr$CV_CI[1])

#Create table
MLESE <- data.frame((matrix(NA, nrow=4, ncol=7)))

#Insert values in the table 
MLESE [,1] <-MetaSum$Modality
MLESE [,2] <-MetaSum$n1
MLESE [,3] <-paste0(round(MetaSum$metad,2))
MLESE [,4] <-paste0(round(MetaSum$metad_sd,2))
MLESE [2,5] <- paste0(round(table3b[1,2],3), "*") # Mem & Cal
MLESE [3,5] <- paste0(round(table3b[3,2],3), "*")# Mem & GDP
MLESE [4,5] <- paste0(round(table3b[2,2],3))# Mem & Vis
MLESE [3,6] <- paste0(round(table3b[5,2],3)) # Cal & GDP
MLESE [4,6] <- paste0(round(table3b[6,2],3), "*") # Cal & Vis
MLESE [4,7] <- paste0(round(table3b[4,2],3))# GDP & Vis
#  * : under 0.05 - can be seen in dataframe tabl

#Rename and select Columns: 
MLESE  <- MLESE %>%  mutate(Modality =X1, n=X2, M=X3, SD=X4, Memory = X5, Calories = X6, GDP =X7) %>%
  select(Modality, n, M, SD, Memory, Calories, GDP)


#Write csv
write.csv(MLESE ,file= here("tables", 'SenCor_MLE.csv'))

#APA format:
CorSen<-apa(MLESE, "Table 3: Correlation of Metacognitive Sensitivity")

CorSen

```

Table 4: Correlation of Hierarchical correlation: 
```{r}
#See Fit_hierarchical 
```


Tables in Supplementary Material: 

Split half analysis: in SplitHalf.RMd and SplitHald_Hier.Rmd
ANOVA: in ANOVA.Rmd

Bayes Factor: 
```{r}

#Change labels
BayesSen1 <- BayesSenE %>% mutate(`meta-d'` = `Bayes Factor`) %>% select(-`Bayes Factor`)
BayesEff1 <- BayesEffE %>% mutate(`meta-d/d''` = `Bayes Factor`) %>% select(-`Bayes Factor`)
BayesBia1 <- BayesBiaE %>% mutate(`Avg. Conf` = `Bayes Factor`) %>% select(-`Bayes Factor`)
BayesCog1 <- BayesCogE %>% mutate(`d'` = `Bayes Factor`) %>% select(-`Bayes Factor`)

#Join the dataframes:
Bayes1 <- left_join(BayesSen1, BayesEff1, 
                     by=c("Pair"="Pair"))
Bayes2 <- left_join(BayesCog1, BayesBia1, 
                     by=c("Pair"="Pair"))
Bayes <- left_join(Bayes2, Bayes1, 
                     by=c("Pair"="Pair"))
#write csv
write.csv(Bayes ,file= here("tables", 'MLECorrBayes_Excl.csv'))

#apa
BayesT <- apa(Bayes, "Table X: Bayes factor: Metacognitive Sensitivity, Efficiency, and Bias (MLE)")
BayesT

```

CHECK IF THESE CAN BE DELETED ?!?!?!?!?

```{r}


#Change format: 
tableMLE <- metadata_avg %>% mutate(Modality=c("Calories", "GDP", "Memory", "Vision"),
                                  'dprime (SD)'=paste0((round(dprime,3)), paste0(" (", round(dprime_sd,3), ")")),
                                  'Criterion (SD)'=paste0((round(criterion,3)), paste0(" (", round(criterion_sd,3), ")")),
                                  'Meta-d (SD)'=paste0((round(metad,3)), paste0(" (", round(metad_sd,3), ")")),
                                  'Mratio (SD)'=paste0((round(mratio1,3)), paste0(" (", round(mratio_sd,3), ")")),
                                  'Avg Conf (SD)'=paste0((round(avg_conf1,3)), paste0(" (", round(avg_conf_sd,3), ")"))
                                  ) 
tableMLE <- tableMLE %>% select(Modality, 'dprime (SD)', 'Criterion (SD)', 'Avg Conf (SD)', 'Meta-d (SD)', 'Mratio (SD)')   

# Mratio estimations from Hierarhical Model.  

#Select Mratio and take the expontial of the value:
meanMratio <- Fit %>% filter(str_detect(name,"mu_logMratio")) %>%
  mutate(mean=exp(mean), 
         lower=exp(lower),
         upper=exp(upper))
  
#format and select: 
meanMratio <- meanMratio %>% mutate(Modality=c("Memory", "Calories", "GDP", "Vision"),
         'HMratio (HDI)'=paste0(round(mean,3), paste0(" (", round(lower,3),";",round(upper,3), ")"))) 
         
meanMratio <- meanMratio %>% select(Modality, 'HMratio (HDI)')
  
#Join the two tables MLE and Hierarhical dataframes. 

table3 <- left_join(tableMLE, meanMratio, 
                     by=c("Modality"="Modality"))


#Put into APA format.                                     
table3apa<-apa(table3, "Table 4: Cognitive and Metacognitive performance")

######Save tables. 
#######################
###

table3apa

```



Table 2: Hierarchical correlation of Metacognitive efficiency
NOTE you need the hierarhical fit to do this. 
```{r}

# select the HDIs for each rho  
rHDI <- HDI %>% filter(str_detect(name,"rho")) %>% select(name, lower, upper)
#join these HDIs with mean rho
RhoHDI <- full_join(meanRho, rHDI, 
                    by= c("Parameter"="name"))

#Change names and layout: 
Table2H <- RhoHDI %>% mutate(Pair= c("Memory & Calories", "Memory & Vision", "Memory & GDP", 
                                     "GDP & Vision", "GDP & Calories", "Calories & Vision"),
                             Rho=round(value,3),
                             HDI = paste(round(lower,3), round(upper,3), sep=";")
                             )

Table2H <- Table2H %>% mutate(`Rho (HDI)`= paste0(Rho, " (", HDI, ")" )) %>% select(Pair, `Rho (HDI)`)


#Put into APA format. 

Table2Hapa<-apa(Table2H, "Table 3: Hierarhical Bayesian estimation of correlation of Metacognitive Efficiency")

######Save tables. 
#######################
###

Table2Hapa
  
```

MLE and Hierarchical fit of Mratio correlations:
```{r}
table23 
Table2H

TableHM <- full_join(table23, Table2H, by=c("Pair"="Pair"))
TableHM <- TableHM %>% mutate( `MLE fit` = paste0("r(314) = ", r, " ",`p-value (CI)`),
                               `Hierarchical fit` = `Rho (HDI)`) %>% 
  select(Pair, `MLE fit`, `Hierarchical fit`)

TableHMapa<-apa(TableHM, "Table 3: MLE and Hierarhical Bayesian estimation of correlation of Metacognitive Efficiency")

######Save tables. 
#######################
###

TableHMapa
```



Table 2: MLE correlation between domains 
```{r}

#Change the layout of the table: 

##Sensitivity 
#Table with correlation coefficents for all pairwise correlations: 
table22 <- data.frame(Pair=character(),
                 r=double(),
                 p=double(),
                 'Conf Interval'=double(),
                stringsAsFactors=FALSE)

#Insert vaules in dataframe: 
table22[1,] <- list("Memory & Calories",table2$MemCalCoef[1],table2$P_valueMC[1], table2$MC_CI[1])
table22[2,] <- list("Memory & Vision",table2$MemVisCoef[1],table2$P_valueMV[1], table2$MV_CI[1])
table22[3,] <- list("Memory & GDP",table2$MemGDPCoef[1],table2$P_valueMG[1], table2$MG_CI[1])
table22[4,] <- list("GDP & Vision",table2$GDPVisCoef[1],table2$P_valueGS[1], table2$GS_CI[1])
table22[5,] <- list("GDP & Calories",table2$GDPCalCoef[1],table2$P_valueGC[1], table2$GC_CI[1])
table22[6,] <- list("Calories & Vision",table2$CalVisCoef[1],table2$P_valueCV[1], table2$CV_CI[1])

#Combine p and C-value: 
table22 <- table22 %>% mutate(`p-value (CI)`= paste0('p = ', table22$p, ' (', table22$Conf.Interval, ')')) %>% select(Pair,r, `p-value (CI)`)




saveRDS(x, file = "myvector_serialized.rds")
x <- readRDS("myvector_serialized.rds")

##Efficiency


##Bias
#Table with correlation coefficents for all pairwise correlations: 
table24 <- data.frame(Pair=character(),
                 r=double(),
                 p=double(),
                 'Conf Interval'=double(),
                stringsAsFactors=FALSE)

#Insert vaules in dataframe: 
table24[1,] <- list("Memory & Calories",table2$MemCalCoef[3],table2$P_valueMC[3], table2$MC_CI[3])
table24[2,] <- list("Memory & Vision",table2$MemVisCoef[3],table2$P_valueMV[3], table2$MV_CI[3])
table24[3,] <- list("Memory & GDP",table2$MemGDPCoef[3],table2$P_valueMG[3], table2$MG_CI[3])
table24[4,] <- list("GDP & Vision",table2$GDPVisCoef[3],table2$P_valueGS[3], table2$GS_CI[3])
table24[5,] <- list("GDP & Calories",table2$GDPCalCoef[3],table2$P_valueGC[3], table2$GC_CI[3])
table24[6,] <- list("Calories & Vision",table2$CalVisCoef[3],table2$P_valueCV[3], table2$CV_CI[3])

#NOTE I MANUALLY CHANGE THE P-values to <.001 here! Thus with different data this may not be appropriate. 
table24 <- table24 %>% mutate(p = as.character("<.001"))
#Combine p and C-value: 
table24 <- table24 %>% mutate(`p-value (CI)`= paste0('p = ', table24$p, ' (', table24$Conf.Interval, ')')) %>% select(Pair,r, `p-value (CI)`)


#Combine p and C-value: 
table2 <- table2 %>% mutate(`p-value (CI)`= paste0('p = ', table2$p, ' (', table2$Conf.Interval, ')')) %>% select(Pair,r, `p-value (CI)`)
table2 <- table2 %>% mutate(r = round(r,3))
table2 <- table2 %>% mutate( `Spearman's Correlation` = paste0("r(314) = ", r, " ",`p-value (CI)`)) %>% select(Pair, `Spearman's Correlation`)


#Sort decimals: 
table22 <- table22 %>% mutate(r = round(r,3))
table24 <- table24 %>% mutate(r = round(r,3))


#Makes tables in APA format: 

CorSen<-apa(table22, "Table 2.b: MLE correlation of Metacognitive Sensitivity")
CorBias<-apa(table24, "Table 2.c: MLE correlation of Metacognitive Bias")


######Save tables. 
#######################
###

CorBias
CorSen
CorEff
CorD

```







Here are some additional plots - you can un-comment these sections to see them.
Note that the individual staircase plots may take a LONG time to produce. 

Plots of key metacognitive measures for both filtered and unfiltered data: 
```{r}
#Source here to get the additional plots of the distribution of d', criterion,
#meta-d', bias and m-ratio across condition, both before and after group-level
#exclusion: 

#source(here("r", "MLE_plots.R"))

#Plots showing the comparison of filtered and unfiltered plots: 
#annotate_figure(filunfil1, top = text_grob("Cognitive Criterion filtered/unfiltered", color = "black", face = "bold", size = 14))
#annotate_figure(filunfil5, top = text_grob("Cognitive Sensitivity filtered/unfiltered", color = "black",face = "bold", size = 14))
#annotate_figure(filunfil2, top = text_grob("Metaognitive Bias filtered/unfiltered", color = "black", face = "bold", size = 14))
#annotate_figure(filunfil3, top = text_grob("Metacognitive Sensitivity filtered/unfiltered",   color = "black", face = "bold", size = 14))
#annotate_figure(filunfil4, top = text_grob("Metacognitive Efficiency filtered/unfiltered", color = "black",  face = "bold", size = 14))

#Plot the unfiltered data: 
#annotate_figure(Dataunfil1, top = text_grob("MLE Estimation of Cognitive performance (unfiltered)", color = "black",face = "bold", size = 14))  
#annotate_figure(Dataunfil2, top = text_grob("MLE Estimation of Metacognitive performance (unfiltered)", color = "black", face = "bold", size = 14))  

#Plot the filtered data: 
#annotate_figure(Datafil1, top = text_grob("MLE Estimation of Cognitive performance (filtered)", color = "black",face = "bold", size = 14))  
#annotate_figure(Datafi2, top = text_grob("MLE Estimation of Metacognitive performance (unfiltered)", color = "black", face = "bold", size = 14)) 

```

Additional scatter plots and linear regressions: 
```{r}
#For scatters plots of MLE estimation of metacognitive bias and sensitvity, 
#source here: 

#source(here("r", "Scatterplots.R"))

#Plot them: 
#annotate_figure(comPlot1, top = text_grob("Metacognitive Sensitivity", color = "black", face = "bold", size = 14))  
#annotate_figure(comPlot3, top = text_grob("Metacognitive Bias", color = "black", face = "bold", size = 14))   

```


Individual-level staircase plots: (Takes a long time)
```{r}
# note that this procedure can take a LONG time 
#uncomment to make individual plots for staircase procedure:

#source(here("r", "make_indivi_plots.R"))

```

Demographics (NOT IN THE PAPER ANYMORE) 
```{r}
#load the demographics information: 
#survey_data_pre <- read_delim(here("data_summary", "/self_belief_pre_labels.csv"), 
                            #  ";", escape_double = FALSE, trim_ws = TRUE)

#Clean Data: 
#survey_data_pre <- survey_data_pre %>% select(Sid, age, gender)

#Vector with IDs that should be included
#ID_incl <- unique(metadata_exc$subject)

#demo only with included participants:
#demo <- subset(survey_data_pre, is.element(survey_data_pre$Sid, ID_incl))

#summarise and format Gender:
#demoG <- demo %>% group_by(gender) %>% 
 # summarise(mean1=length(gender)) %>% mutate(per = 100*mean1/321) %>%
  #mutate(Count=paste0(round(mean1), paste0(" (", round(per,2), " %)"))) %>% mutate(Gender=gender)%>%
  #select(Gender, Count) 


#summarise and format age:
#demoA <- demo %>% group_by(gender) %>% summarise(age1 =mean(age, na_rm=TRUE),
 #                        age_sd=sd(age, na.rm=TRUE)) %>% 
  #mutate(Age= paste0(round(age1), paste0(" (", round(age_sd,3), " SD)"))) %>% select(Age, gender)


#MANUALLY CHANGE NON_BINARY AGE
#demoA[3,1] <-'21 (0 SD)' 

#Join the two tables: 
#table1 <- full_join(demoG, demoA, by = c("Gender"="gender"))
#table1[3,1] <-'Non-binary'

#Apa format:
#table1apa<-apa(table1, "Table 1: Demographics")
#table1apa

```

playing with qgraph

```{r}

corr_plot_data <- mle_fit_data_wide %>%
  na.omit() %>%
  select(-subject) %>%
  select(-starts_with("mratio"))

qgraph(cor(corr_plot_data), layout="circle", theme = "colorblind", graph = 'pcor', threshold = "holm", 'sampleSize' = 312)

qgraph(cor(corr_plot_data), layout="circle", theme = "colorblind", graph = 'glasso','sampleSize' = 312, threshold = TRUE)

```

